# Active Investigation

Last updated: 2026-02-13
Status: active

## Objective

Close the remaining strict encoder quality gap (`Q >= 0`) without parity regressions or hot-path allocation regressions.

## Current Hypothesis

The highest ROI is targeted SILK/Hybrid quality tuning first, validated against pinned libopus fixtures, before broad CELT retuning.

## Next 3 Actions (Targeted)

1. Pick one failing/weak quality profile and lock a single reproducible fixture case.
2. Run only the narrowest parity/compliance tests needed for that profile before code edits.
3. Capture a short evidence note in this file with command, result, and next decision.

## Feature Parity Plan (libopus 1.6.1)

- [x] Complete: Wire full multistream surround-analysis and energy-mask production into `surroundTrim` control flow for alloc-trim parity (encoder-side `surroundTrim` state plumbing is done; producer/control path is still pending).
- [x] Complete: Implement LFE-aware multistream handling parity (stream detection, mapping policy, and allocation effects).
- [x] Complete: Match libopus surround per-stream control policy parity (mode forcing, channel decisions, and bandwidth policy).
- [x] Complete: Close remaining public CTL/API parity gaps versus libopus request/set/get surfaces.
- [x] Complete: Add repacketizer API parity coverage with fixture-validated behavior.
- [x] Complete: Tighten ambisonics behavior parity (mapping/control/packet behavior parity tests).

## Explicit Skips For This Session

- Skip re-debugging SILK decoder correctness unless decoder-path files are touched.
- Skip re-debugging resampler parity unless resampler-path files are touched.
- Skip re-investigating NSQ constant-DC amplitude behavior unless evidence conflicts with known expected dithering behavior.

## Stop Conditions

- Stop and reassess after 3 failed hypotheses without measurable quality uplift.
- Escalate to broad gate (`make verify-production`) only when a focused change is ready for merge-level validation.

## Evidence Log (Newest First)

- 2026-02-13: Continued post-parity strict-quality closure with a narrow CELT 10ms mono budget uplift in `celt/encode_frame.go` (`computeTargetBits`): raised non-hybrid/non-LFE `frameSize==480` mono uplift from `+128` to `+256` bits while keeping stereo and other frame-size uplifts unchanged. Focused quality evidence: `go test ./testvectors -run 'TestEncoderComplianceCELT/FB-10ms-mono' -count=1 -v` improved from `Q=-11.84` (~42.31 dB) baseline to `Q=-11.14` (~42.65 dB), with target bits avg `1229 -> 1358`. Regression evidence: `go test ./testvectors -run TestEncoderComplianceCELT -count=1 -v` PASS, `go test ./testvectors -run TestEncoderComplianceSummary -count=1 -v` PASS (summary `CELT-FB-10ms-mono-64k` now `Q=-11.14`), `go test ./testvectors -run 'TestEncoderCompliancePrecisionGuard|TestEncoderVariantProfileParityAgainstLibopusFixture' -count=1 -v` PASS, `go test ./celt -run 'TestOpusdecCrossvalFixtureCoverage|TestOpusdecCrossvalFixtureHonestyAgainstLiveOpusdec' -count=1 -v` PASS, `make verify-production` PASS, `make bench-guard` PASS. Next decision: keep this bounded 10ms mono uplift and move next slice toward remaining high-impact CELT/Hybrid strict-quality deltas without regressing parity fixtures.
- 2026-02-13: Completed surround per-stream control policy parity by aligning `multistream/encoder.go` `applyPerStreamPolicy` with libopus `opus_multistream_encoder.c`: for surround mapping, per-frame control now sets bandwidth on all streams and force-sets only coupled streams (`ModeCELT` + `ForceChannels(2)`), while mono/LFE force-channel settings are preserved; for ambisonics mapping, per-frame control forces CELT mode but preserves caller force-channel setting. Removed prior over-forcing (`ForceChannels(-1)` on mono/ambisonics and per-frame LFE `ModeCELT`/`ForceChannels(1)`/NB bandwidth override). Updated tests in `multistream/encoder_test.go`: refined `TestEncode_SurroundPerStreamPolicy` to assert coupled-only forcing, per-stream surround bandwidth policy, and preserved mono/LFE defaults; added `TestEncode_SurroundPolicyPreservesMonoForceChannels`; updated `TestEncode_AmbisonicsForcesCELTMode` to assert user force-channels preservation under ambisonics. Validation: focused policy tests PASS (`go test ./multistream -run 'TestEncode_SurroundPerStreamPolicy|TestEncode_SurroundPolicyPreservesMonoForceChannels|TestEncode_AmbisonicsForcesCELTMode|TestAllocateRates_SurroundLFEAware' -count=1 -v`), additional multistream/root slices PASS, `make verify-production` PASS, `make bench-guard` PASS. Next decision: with all listed libopus parity checklist items now complete, continue strict quality-target closure work and keep parity guards as merge blockers.
- 2026-02-13: Completed LFE-aware multistream parity slice by wiring explicit per-stream LFE flag propagation from multistream mapping detection into encoder/CELT controls and behavior. Added LFE state/control in `encoder/encoder.go` and `celt/encoder.go` (`SetLFE`/`LFE`), propagated to CELT init path, forced CELT-only mode with narrowband effective bandwidth when LFE is enabled, and marked multistream stream encoders with `SetLFE(i==lfeStream)` at construction/reset/per-frame policy application (`multistream/encoder.go`). Added LFE-aware CELT parity gates in `celt/encode_frame.go` and `celt/energy_encode.go` (disable LFE-incompatible TF/trim/target-bit uplifts and apply coarse-energy LFE constraints). Added focused tests: `multistream/encoder_test.go` (`TestNewEncoderDefault_SetsLFEFlags`, updated `TestEncode_SurroundPerStreamPolicy`), `encoder/lfe_internal_test.go` (`TestLFEEffectiveBandwidthClamp`, `TestLFEModeForcesCELTPath`), `celt/encoder_test.go` (`TestEncoderSetLFE`), and `celt/target_bits_test.go` (`TestComputeTargetBitsLFEAvoidsNonLFEBudgets`). Validation: focused multistream/encoder/celt LFE slices PASS, `go test . -run TestMultistreamEncoder_Controls -count=1` PASS, `make verify-production` PASS, `make bench-guard` PASS. Next decision: proceed to remaining surround per-stream control policy parity item.
- 2026-02-12: Completed surround-analysis producer parity slice in `multistream/encoder.go` by replacing heuristic channel-shape masking with libopus-style surround analysis flow: per-channel preemphasis memory, overlap window memory, sample-rate resampling-factor handling, short-overlap MDCT analysis, CELT band-energy accumulation/spreading, and channel-position mask synthesis to produce per-channel surround band-SMR. The produced band-SMR now drives per-stream `surroundTrim` derivation used in CELT alloc-trim control flow. Added/updated tests in `multistream/encoder_test.go`: `TestEncode_SurroundBandSMRProduced` (band-SMR production, including zeroed LFE mask channel), `TestEncode_SurroundTrimProducedAt24k` (upsample-path surround-trim production), and existing surround policy/trim tests kept passing. Validation: `go test ./multistream -run 'TestEncode_SurroundTrimProduced|TestEncode_SurroundBandSMRProduced|TestEncode_SurroundTrimProducedAt24k|TestEncode_SurroundPerStreamPolicy|TestAllocateRates_SurroundLFEAware' -count=1 -v` PASS, `make verify-production` PASS, `make bench-guard` PASS. Next decision: close remaining LFE-specific multistream parity and final per-stream surround control policy parity in subsequent slices.
- 2026-02-12: Closed remaining CTL/API parity gaps for this slice by extending multistream public control parity and decoder CTL surfaces. Added multistream wrappers and propagation for application/bitrate-mode/VBR/CVBR/bandwidth/force-channels/prediction/phase-inversion (`multistream.go`, `multistream/encoder.go`), added decoder gain/pitch controls (`decoder.go`: `SetGain`, `Gain`, `Pitch`) with output-gain application during decode/PLC/FEC paths, and introduced `ErrInvalidGain` in `errors.go`. Expanded tests: `TestMultistreamEncoder_Controls` now covers new control wrappers and invalid inputs; added decoder tests `TestDecoder_SetGainBounds`, `TestDecoder_GainAppliedToDecodeOutput`, and `TestDecoder_PitchGetter`. Validation: focused root+multistream parity tests PASS, `go test ./multistream -run 'TestAllocateRates_SurroundLFEAware|TestEncode_SurroundPerStreamPolicy|TestEncode_SurroundTrimProduced|TestEncode_AmbisonicsForcesCELTMode' -count=1 -v` PASS, `make verify-production` PASS, `make bench-guard` PASS. Next decision: proceed to remaining surround-analysis/LFE/policy checklist items and close them in subsequent slices.
- 2026-02-12: Tightened ambisonics parity in `multistream/ambisonics.go` by aligning family-3 channel validation with libopus projection support (orders 1..5 only; reject order 0 and >5), and expanded ambisonics behavior tests in `multistream/ambisonics_test.go` to cover mapping parity for supported family-3 channel sets, explicit rejection of unsupported orders, per-stream control policy parity after encode (CELT-only + auto force-channels + zero surround trim), and packet framing coverage across family-2/family-3 encodes. Validation: `go test ./multistream -run 'TestAmbisonicsMappingFamily3|TestAmbisonicsMappingFamily3_UnsupportedOrders|TestValidateAmbisonicsFamily3|TestValidateAmbisonicsFamily3_UnsupportedOrders|TestNewEncoderAmbisonics_Family3|TestNewEncoderAmbisonics_InvalidChannels|TestEncoderAmbisonics_Encode|TestEncode_AmbisonicsForcesCELTMode' -count=1 -v` PASS, `go test ./multistream -count=1` PASS. Next decision: close remaining surround producer/LFE/control checklist items and any remaining CTL/API parity gaps.
- 2026-02-12: Added public CTL/API parity slice in root wrappers and packet surfaces: `encoder.go` now exposes bitrate-mode controls (`SetBitrateMode`, `BitrateMode`, `SetVBR`, `VBR`, `SetVBRConstraint`, `VBRConstraint`), expected packet-loss controls (`SetPacketLoss`, `PacketLoss`), explicit bandwidth controls (`SetBandwidth`, `Bandwidth`), and application controls (`SetApplication`, `Application`); `multistream.go` now exposes `SetPacketLoss`/`PacketLoss` and `FinalRange` alias parity; `decoder.go` now exposes `Bandwidth`, `LastPacketDuration`, and `InDTX` getters. Implemented public repacketizer/packet API parity in `packet.go`: `Repacketizer` (`NewRepacketizer`, `Reset`, `Cat`, `NumFrames`, `Out`, `OutRange`) plus `PacketPad`, `PacketUnpad`, `MultistreamPacketPad`, `MultistreamPacketUnpad`. Added fixture-validated behavior test `packet_repacketizer_test.go` backed by new `testdata/repacketizer_libopus_fixture.json` (fixture generated from libopus 1.6.1 static lib behavior for repacketizer out/out_range and packet pad/unpad). Validation: focused control/repacketizer tests PASS, `make verify-production` PASS, `make bench-guard` PASS. Next decision: close remaining CTL/API parity deltas (notably decoder gain/pitch-class surfaces and any multistream-control parity gaps) and tighten ambisonics parity tests.
- 2026-02-12: Implemented first multistream surround/LFE parity-control slice in `multistream/encoder.go` and `encoder/encoder.go`: added per-stream surround-aware rate allocation (libopus-style offsets/ratios, including LFE stream treatment), per-frame surround control policy (surround bandwidth forcing thresholds, coupled-stream CELT+stereo forcing, ambisonics CELT forcing), LFE-aware mode/bandwidth handling, and surround-mask producer path that feeds per-stream CELT `surroundTrim` through new encoder controls (`SetCELTSurroundTrim`/`CELTSurroundTrim`). Added focused tests in `multistream/encoder_test.go` for LFE rate effects, surround per-stream policy, surround-trim production, and ambisonics CELT forcing. Validation: `go test ./multistream -run 'TestAllocateRates_SurroundLFEAware|TestEncode_SurroundPerStreamPolicy|TestEncode_SurroundTrimProduced|TestEncode_AmbisonicsForcesCELTMode|TestEncoderSetBitrate|TestEncode_51Surround|TestEncode_71Surround' -count=1 -v` PASS, `go test ./encoder -run 'TestEncoderSetMode|TestFECPacketLoss|TestModeAutoSelection' -count=1` PASS, `go test ./testvectors -run TestEncoderComplianceSummary -count=1 -v` PASS, `make verify-production` PASS, `make bench-guard` PASS. Next decision: close remaining public CTL/API parity, repacketizer parity coverage, and ambisonics behavior parity tests.
- 2026-02-12: Implemented CELT surround-trim wiring by replacing the hardcoded `surroundTrim=0.0` path in `celt/encode_frame.go` with encoder state (`e.surroundTrim`), plus encoder controls/tests (`SetSurroundTrim`, reset clear, and alloc-trim monotonic checks). Validation: `go test ./celt -run 'TestEncoderSetSurroundTrim|TestEncoderResetClearsSurroundTrim|TestAllocTrimSurroundTrimAdjustment|TestAllocTrimAnalysis' -count=1 -v` PASS, `go test ./testvectors -run 'TestEncoderComplianceSummary|TestEncoderCompliancePrecisionGuard|TestEncoderVariantProfileParityAgainstLibopusFixture' -count=1 -v` PASS, `make verify-production` PASS, `make bench-guard` PASS. Next decision: keep surround-trim state plumbed and defaulted to `0` until a libopus-parity surround mask producer is wired into multistream control flow.
- 2026-02-12: Addressed next quality issue after PR #31 by improving CELT 10ms stereo budget in `celt/encode_frame.go` (`computeTargetBits`): added a stereo-only uplift (`frameSize==480`, `channels==2`, `+128` bits on top of existing 10ms boost). Focused evidence: `go test ./testvectors -run 'TestEncoderComplianceCELT/FB-10ms-stereo' -count=1 -v` improved `Q=-26.80` (~35.14 dB) to `Q=-22.48` (~37.21 dB), avg target bits `1197 -> 1453`. Guard evidence: `go test ./testvectors -run TestEncoderComplianceCELT -count=1 -v` PASS, `go test ./testvectors -run 'TestEncoderComplianceSummary|TestEncoderCompliancePrecisionGuard|TestEncoderVariantProfileParityAgainstLibopusFixture' -count=1 -v` PASS, `go test ./encoder -run TestCELTLongFrameVBRBitrateBudget -count=1 -v` PASS, `make verify-production` PASS, `make bench-guard` PASS. Next decision: keep this stereo-specific 10ms uplift and continue strict-quality closure on remaining short-frame/stereo gaps.
- 2026-02-12: Optimized CI Linux gate topology to reduce wall-clock without dropping checks. Updated `.github/workflows/ci.yml` to split prior `test-linux-verify` into parallel `test-linux-parity` (full `GOPUS_TEST_TIER=parity go test ./...`) and `test-linux-race` (`make test-race`), kept `test-linux-provenance`, and updated `test-linux` aggregator to require all three. Baseline timing evidence from recent successful runs (`gh run view 21964360695`, `gh run view 21964143086`, `gh run view 21963310494`) showed serialized `test-linux-verify` as critical path (~5m51s to ~6m28s). Local validation: YAML parse PASS (`ruby -e "require 'yaml'; YAML.load_file('.github/workflows/ci.yml')"`), compile/no-test sweep PASS (`go test ./... -run '^$' -count=1`), full gate PASS (`make verify-production`), and standalone perf gate PASS (`make bench-guard`). Next decision: observe next CI runs and confirm linux critical path drops while preserving parity/race/provenance coverage.
- 2026-02-12: Cross-platform follow-up after PR #31 CI: `test-windows` failed `TestEncoderCompliancePrecisionGuard` on three recently ratcheted floors (`SILK-WB-10ms-mono-32k`, `SILK-WB-60ms-mono-32k`, `Hybrid-SWB-10ms-mono-48k`). Applied calibrated floors that remain tighter than the previous baseline: `-0.05`, `-0.25`, and `-0.15` respectively. Validation: `go test ./testvectors -run 'TestEncoderCompliancePrecisionGuard|TestEncoderComplianceSummary|TestEncoderVariantProfileParityAgainstLibopusFixture' -count=1 -v` PASS, `make verify-production` PASS, `make bench-guard` PASS. Next decision: keep broad ratchet with these Windows-calibrated exceptions; tighten further only with new multi-OS headroom evidence.
- 2026-02-12: Tightened encoder precision floors broadly in `testvectors/encoder_precision_guard_test.go` after the CELT short-frame uplifts by ratcheting 14/19 summary profiles (CELT and most SILK/Hybrid entries), while preserving known Windows-sensitive floors unchanged (`SILK-WB-40ms-mono-32k=-0.35`, `Hybrid-FB-20ms-mono-64k=-0.55`, `Hybrid-FB-60ms-mono-64k=-0.55`, `Hybrid-FB-20ms-stereo-96k=-0.25`). Validation: `go test ./testvectors -run 'TestEncoderCompliancePrecisionGuard|TestEncoderComplianceSummary|TestEncoderVariantProfileParityAgainstLibopusFixture' -count=1 -v` PASS, `make verify-production` PASS, `make bench-guard` PASS. Next decision: keep the broader ratchet and only tighten the four held floors with new multi-OS CI headroom evidence.
- 2026-02-12: Implemented second CELT 2.5ms uplift pass by raising non-hybrid `frameSize==120` boost from `+128` to `+192` bits in `celt/encode_frame.go` (`computeTargetBits`). Quality evidence: `go test ./testvectors -run 'TestEncoderComplianceCELT/FB-2.5ms-mono' -count=1 -v` improved from `Q=-30.98` (~33.13 dB, avg target 372 bits) to `Q=-25.58` (~35.72 dB, avg target 436 bits). Guard evidence: `go test ./testvectors -run 'TestEncoderComplianceSummary|TestEncoderCompliancePrecisionGuard|TestEncoderVariantProfileParityAgainstLibopusFixture' -count=1 -v` PASS, `go test ./encoder -run TestCELTLongFrameVBRBitrateBudget -count=1 -v` PASS, `make verify-production` PASS, `make bench-guard` PASS. Next decision: keep `+192` as current best validated 2.5ms setting and continue strict-quality closure on remaining short-frame/stereo cases.
- 2026-02-12: Completed docs/readme sync pass across root markdown and examples docs, including new assembly coverage documentation (`ASSEMBLY.md`) and README linkage. Resolved stale docs drift (`examples/README.md` Go version floor, removed reference to nonexistent `.planning/STATE.md`, synced `CODEX.md`/`CLAUDE.md` first-reply checklist with AGENTS). Validation: `go test ./... -run '^$' -count=1` PASS, `make verify-production` PASS, `make bench-guard` PASS. Next decision: treat `ASSEMBLY.md` as the single assembly coverage inventory and update it whenever `.s` surfaces or build tags change.
- 2026-02-12: Tightened validation floors across the summary matrix in `testvectors/encoder_precision_guard_test.go` with a broad +0.30 dB ratchet, then applied targeted cross-platform headroom adjustments for four Windows-sensitive speech profiles (`SILK-WB-40ms-mono-32k`, `Hybrid-FB-20ms-mono-64k`, `Hybrid-FB-60ms-mono-64k`, `Hybrid-FB-20ms-stereo-96k`) after CI evidence. Validation: local `TestEncoderCompliancePrecisionGuard`, `TestEncoderComplianceSummary`, `TestEncoderVariantProfileParityAgainstLibopusFixture`, `make verify-production`, and `make bench-guard` PASS; Windows failure root cause captured from PR #30 CI logs and resolved in-threshold update.
- 2026-02-12: Implemented next short-frame quality uplift: non-hybrid CELT `frameSize==240` receives `+64` target bits in `celt/encode_frame.go` (`computeTargetBits`). Quality evidence: `go test ./testvectors -run TestEncoderComplianceCELT -count=1 -v` PASS with `FB-5ms-mono` improving from `Q=-18.10` (~39.31 dB) to `Q=-14.05` (~41.25 dB), target stats avg `473 -> 548` bits. Guard evidence: `go test ./testvectors -run 'TestEncoderComplianceSummary|TestEncoderCompliancePrecisionGuard|TestEncoderVariantProfileParityAgainstLibopusFixture' -count=1 -v` PASS, `go test ./encoder -run TestCELTLongFrameVBRBitrateBudget -count=1 -v` PASS, `make verify-production` PASS, `make bench-guard` PASS. Next decision: keep `+64` at 5ms and continue short-frame/stereo quality closure while preserving libopus parity.
- 2026-02-12: Addressed CELT short-frame under-allocation by adding a non-hybrid `frameSize==120` boost of `+128` bits in `celt/encode_frame.go` (`computeTargetBits`). Quality evidence: `go test ./testvectors -run TestEncoderComplianceCELT -count=1 -v` PASS with `FB-2.5ms-mono` improved from `Q=-43.27` (~27.23 dB) to `Q=-30.98` (~33.13 dB), and target stats increased from avg `226` to `372` bits. Guard evidence: `go test ./celt -run TestCeltTargetBits25ms -count=1 -v` PASS, `go test ./encoder -run TestCELTLongFrameVBRBitrateBudget -count=1 -v` PASS, `go test ./testvectors -run 'TestEncoderComplianceSummary|TestEncoderCompliancePrecisionGuard|TestEncoderVariantProfileParityAgainstLibopusFixture' -count=1 -v` PASS, `make verify-production` PASS, `make bench-guard` PASS. Next decision: keep the `+128` 2.5ms boost as current best validated short-frame setting and continue strict-quality closure on SILK/Hybrid.
- 2026-02-12: Investigated PR #28 CI failures on linux/windows (`TestOpusdecCrossvalFixtureCoverage` missing SHA entries). Root cause: `make fixtures-gen-amd64` regenerated libopus amd64 fixtures but not `celt/testdata/opusdec_crossval_fixture_amd64.json`, while `celt` tests select `_amd64` fixtures on `runtime.GOARCH=="amd64"`. Fix: added `GOPUS_OPUSDEC_CROSSVAL_FIXTURE_OUT` support to `tools/gen_opusdec_crossval_fixture.go`, wired generator into `fixtures-gen-amd64`, then regenerated amd64 fixture with `make fixtures-gen-amd64`. Validation: linux/amd64 container run of `go test ./celt -run 'TestOpusdecCrossvalFixtureCoverage|TestOpusdecCrossvalFixtureHonestyAgainstLiveOpusdec' -count=1 -v` PASS; broad gate `make verify-production` PASS. Next decision: keep arch-specific crossval fixture regeneration coupled to amd64 fixture workflow.
- 2026-02-12: Finalized CELT 20ms non-hybrid boost ceiling at `+1216` bits for high-budget frames (`baseBits >= 1024`) and kept reduced-budget subframes at `+256` in `celt/encode_frame.go`. Quality evidence: `go test ./testvectors -run TestEncoderComplianceSummary -count=1 -v` PASS with `CELT-FB-20ms-mono-64k Q=-8.27` and `CELT-FB-20ms-stereo-128k Q=-9.01` (up from prior baseline `Q=-9.91` / `Q=-11.99`; approx +1.64 dB and +2.98 dB SNR). Guardrails: `TestEncoderCompliancePrecisionGuard`, `TestEncoderVariantProfileParityAgainstLibopusFixture`, `TestCELTLongFrameVBRBitrateBudget` all PASS. Broad gate: `make verify-production` PASS (parity, bench-guard, race). Next decision: keep `+1216` ceiling as current best validated setting.
- 2026-02-12: Ran high-budget CELT boost sweep (`+512,+640,+768,+896,+1024,+1152,+1216,+1280`) against libopus-anchored guards. Result: quality continued improving up to `+1280` but `go run ./tools/gen_opusdec_crossval_fixture.go` failed on `stereo_20ms_silence` with libopus `opusdec` open/decode failure; `+1216` is highest tested value that preserves fixture generation and live-opusdec honesty checks. Next decision: do not exceed `+1216` without first fixing silence-packet interoperability.
- 2026-02-12: Regenerated CELT opusdec crossval fixture after intentional CELT packet-budget change: `go run ./tools/gen_opusdec_crossval_fixture.go` (wrote `celt/testdata/opusdec_crossval_fixture.json`). Verified fixture parity with live decoder: `go test ./celt -run 'TestOpusdecCrossvalFixtureCoverage|TestOpusdecCrossvalFixtureHonestyAgainstLiveOpusdec' -count=1 -v` PASS. Broad gate now clean: `make verify-production` PASS (includes parity tests, bench-guard, and race). Next decision: keep fixture update with codec change to maintain deterministic crossval coverage.
- 2026-02-12: Implemented targeted CELT budget uplift in `celt/encode_frame.go` (`computeTargetBits`: keep +128 for 10ms and add +256 for 20ms when non-hybrid). Validation: `go test ./testvectors -run TestEncoderComplianceSummary -count=1 -v` (PASS) with measurable CELT gains (`CELT-FB-20ms-mono-64k: Q -9.91 -> -9.34`, `CELT-FB-20ms-stereo-128k: Q -11.99 -> -10.84`; +0.28 to +0.55 dB SNR). Guardrails still green: `go test ./testvectors -run TestEncoderCompliancePrecisionGuard -count=1 -v` PASS, `go test ./encoder -run 'TestHybridVBRBitrateBudget|TestCELTLongFrameVBRBitrateBudget' -count=1 -v` PASS, `go test ./testvectors -run TestEncoderVariantProfileParityAgainstLibopusFixture -count=1 -v` PASS. Next decision: keep this CELT uplift and re-run merge-level gates before handoff.
- 2026-02-12: Tested long-frame SWB ModeAuto hint retuning against `TestEncoderVariantProfileParityAgainstLibopusFixture` focused cases (`HYBRID-SWB-40ms-*`, `HYBRID-FB-60ms-*`). Result: unstable mode switching caused worse ratchet metrics in SWB speech/am_multisine; hypothesis rejected and encoder-mode heuristic edits were reverted. Next decision: avoid SWB ModeAuto heuristic churn in this session and prioritize deterministic CELT quality uplift.
- 2026-02-12: Ran narrow speech-mode slices for rapid repro: `go test ./testvectors -run 'TestEncoderComplianceSILK/WB-20ms-mono' -count=1 -v` and `go test ./testvectors -run 'TestEncoderComplianceHybrid/SWB-20ms-mono' -count=1 -v` (both PASS; absolute quality baseline remains ~`Q=-50.7`, near 23.6-23.7 dB SNR). Next decision: inspect encoder-side SILK analysis/gain/noise-shaping parity path for targeted uplift opportunities.
- 2026-02-12: Ran `go test ./testvectors -run TestEncoderComplianceSummary -count=1 -v` (PASS, `19 passed, 0 failed`); parity-gap status remains GOOD/BASE across fixtures, but strict absolute target (`Q >= 0`) still unmet (worst current CELT absolute Q observed: `CELT-FB-20ms-stereo-128k` at `Q=-11.99`). Next decision: use a narrower CELT slice for fast iterations, then implement targeted encoder-side quality tuning.
- 2026-02-12: Initialized active-memory workflow for agent sessions; no codec math changes in this update.
