# Active Investigation

Last updated: 2026-02-16
Status: active

## Objective

Close the remaining strict encoder quality gap (`Q >= 0`) while preserving libopus 1.6.1 parity and zero-allocation hot paths.

## Current Hypothesis

With feature-parity checklist items complete, remaining gaps should be closed by direct libopus 1.6.1 source ports (math/control flow/state cadence), not heuristic retuning, and then validated against libopus fixtures.

## Next 3 Actions (Targeted)

1. Close ambisonics internal decode parity drift vs direct libopus decode for family-2/family-3 (largest currently at SOA/SOA+).
2. Add stricter packet-level ambisonics parity assertions (internal vs libopus reference decode) once drift is fixed.
3. Keep merge loop fast: run focused parity slice first, open PR, then complete `make verify-production` + `make bench-guard` before merge.

## Feature Parity Plan (libopus 1.6.1)

- [x] Complete: Wire full multistream surround-analysis and energy-mask production into `surroundTrim` control flow for alloc-trim parity.
- [x] Complete: Implement LFE-aware multistream handling parity (stream detection, mapping policy, allocation effects).
- [x] Complete: Match libopus surround per-stream control policy parity (mode forcing, channel decisions, bandwidth policy).
- [x] Complete: Close remaining public CTL/API parity gaps versus libopus request/set/get surfaces.
- [x] Complete: Add repacketizer API parity coverage with fixture-validated behavior.
- [~] In progress: Tighten ambisonics behavior parity (family 2/3 decode now validated via direct libopus API helper; internal ambisonics decode parity drift remains and needs source-port alignment).

## Explicit Skips For This Session

- Skip re-debugging SILK decoder correctness unless decoder-path files are touched.
- Skip re-debugging resampler parity unless resampler-path files are touched.
- Skip re-investigating NSQ constant-DC amplitude behavior unless evidence conflicts.

## Stop Conditions

- Stop and reassess after 3 failed hypotheses without measurable quality uplift.
- Run broad gate (`make verify-production`) only once a focused change is ready.

## Evidence Log (Newest First)

- 2026-02-16: Extended `examples/mix-arrivals` with a listener mode for local audible verification of mixed output and hardened the playback helper for runtime use. Added CLI flag `-play` in `examples/mix-arrivals/main.go`, plus cross-platform playback/decode implementation in `examples/mix-arrivals/playback.go` (`ffplay` direct path, Opus->WAV fallback with local player detection, Ogg packet decode via `container/ogg.Reader`, and idempotent WAV writer close semantics). Updated usage docs in `examples/README.md` with playback invocation details. Validation: `go test ./examples/mix-arrivals -count=1`, `go test ./examples/... -count=1`, full `make verify-production` (parity + bench-guard + race), and standalone `make bench-guard` all passed.
- 2026-02-16: Replaced ambisonics family-2/3 decode checks in `multistream/libopus_test.go` from `opusdec` dependency to a direct libopus 1.6.1 decoder helper. Added `tools/csrc/libopus_refdecode_multistream.c` (stdin/stdout packet protocol, uses `opus_multistream_decode_float` for families 1/2 and `opus_projection_decode_float` for family 3) and new Go test harness `multistream/libopus_refdecode_test.go` to build/invoke it against `tmp_check/opus-1.6.1/.libs/libopus.a`. `TestLibopus_AmbisonicsFamily2Matrix` and `TestLibopus_AmbisonicsFamily3Matrix` now use this helper as the libopus decode source of truth (with explicit skip only when helper toolchain is unavailable) while retaining `opusinfo` header checks. Validation: focused `go test ./multistream -run 'TestLibopus_(AmbisonicsFamily2Matrix|AmbisonicsFamily3Matrix|DefaultMappingMatrix|FrameDurationMatrix)' -count=1 -v`, package `go test ./multistream -count=1`, and full `make verify-production` passed. New evidence from this helper shows remaining internal ambisonics decode energy drift vs libopus (notably SOA/SOA+ family-3), so this is now the top outstanding parity gap.
- 2026-02-16: Ported encoder-side family-3 projection mixing defaults from libopus `mapping_matrix.c` and wired them into multistream encode flow. Added `multistream/projection_mixing_defaults_data.go` (generated from libopus 1.6.1 mixing matrices for `4/6/9/11/16/18/25/27/36/38ch`) and `multistream/projection_mixing_defaults.go` lookup validation keyed by `(channels,streams,coupled)`. Updated `multistream/encoder.go` to initialize projection mixing coefficients for `NewEncoderAmbisonics(..., mappingFamily=3)` and apply matrix mixing per frame before channel routing in `Encode`. Added focused coverage in `multistream/projection_mixing_test.go` (`TestProjectionMixingDefaultsLibopusParity`, `TestNewEncoderAmbisonicsFamily3InitializesProjectionMixing`, `TestApplyProjectionMixingSwapsChannels`). Validation: `go test ./multistream -run 'Test(ProjectionMixingDefaultsLibopusParity|NewEncoderAmbisonicsFamily3InitializesProjectionMixing|ApplyProjectionMixingSwapsChannels|SetProjectionDemixingMatrixInvalidSize|SetProjectionDemixingMatrixFromFamily3Header|ApplyProjectionDemixingSwapsChannels|Libopus_AmbisonicsFamily2Matrix|Libopus_AmbisonicsFamily3Matrix)' -count=1 -v` and `go test ./multistream -count=1` passed. External `opusdec` open failure for family-2/3 files remains unchanged in this environment and is still tracked separately.
- 2026-02-16: Added a concrete projection-decode parity slice for mapping family 3 by wiring demixing-matrix application into the multistream decoder path. `multistream/decoder.go` now exposes `SetProjectionDemixingMatrix` with strict matrix-shape/mapping validation and stores normalized column-major coefficients; `multistream/multistream.go` now applies projection demixing after channel mapping in both normal decode and PLC decode paths. Updated `multistream/libopus_test.go` `decodeWithInternalMultistream` to consume family-3 `OpusHead.DemixingMatrix` and configure decoder demixing explicitly. Added focused coverage in `multistream/projection_decoder_test.go` (`TestSetProjectionDemixingMatrixInvalidSize`, `TestApplyProjectionDemixingSwapsChannels`, `TestSetProjectionDemixingMatrixFromFamily3Header`). Validation: `go test ./multistream -run 'Test(SetProjectionDemixingMatrixInvalidSize|ApplyProjectionDemixingSwapsChannels|SetProjectionDemixingMatrixFromFamily3Header|Libopus_AmbisonicsFamily2Matrix|Libopus_AmbisonicsFamily3Matrix)' -count=1 -v` and `go test ./multistream -count=1` passed. Remaining observed gap is still external `opusdec` inability to open family-2/3 files in this environment, so that investigation remains open.
- 2026-02-16: Ported libopus 1.6.1 family-3 default projection demixing matrix behavior into `container/ogg` and replaced identity-only defaults for valid projection layouts. Added `container/ogg/projection_demixing_defaults_data.go` (generated from libopus 1.6.1 projection CTLs for channel layouts `4/6/9/11/16/18/25/27/36/38`) and `container/ogg/projection_demixing_defaults.go` lookup logic keyed by `(channels,streams,coupled)` with identity fallback only for invalid tuples. Updated `container/ogg/header.go` to use libopus defaults when `DemixingMatrix` is absent for mapping family 3 and to set default `OutputGain` from libopus matrix gain (notably `3050` for SOA `9/11ch`). Updated `container/ogg/writer.go` config defaults to auto-fill missing family-3 demixing metadata and gain from the same source data. Updated `multistream/libopus_test.go` Ogg header helper to reuse `DefaultOpusHeadMultistreamWithFamily` so harness output matches production header defaults. Added checksum-based parity guards in `container/ogg/projection_demixing_defaults_test.go` (`TestDefaultProjectionDemixingMatrixLibopusParity`, `TestDefaultProjectionDemixingMatrixFallbackIdentity`) plus writer gain assertions in `TestWriterWithConfig_PreservesMappingFamily`. Validation: focused `go test ./container/ogg -run 'Test(DefaultProjectionDemixingMatrixLibopusParity|DefaultProjectionDemixingMatrixFallbackIdentity|WriterWithConfig_PreservesMappingFamily|OpusHeadRoundTrip|OpusHeadErrors)' -count=1 -v`, focused `go test ./multistream -run 'TestLibopus_(AmbisonicsFamily2Matrix|AmbisonicsFamily3Matrix)' -count=1 -v`, package runs `go test ./container/ogg -count=1` and `go test ./multistream -count=1`, and full `make verify-production` passed.
- 2026-02-16: Closed the RFC 8486 family-3 OpusHead metadata validity gap for Ogg handling and re-enabled family-3 multistream parity coverage in the test harness. `container/ogg/header.go` now encodes/parses projection-family (`MappingFamilyProjection`) demixing-matrix payloads (size `2*channels*(streams+coupled)` bytes) and keeps family-specific handling explicit: family 3 uses `DemixingMatrix`, families 1/2/255 use `ChannelMapping`. `container/ogg/writer.go` `WriterConfig` gained `DemixingMatrix` support (with identity default for family 3) and validation of family-3 demixing payload size. Added/expanded coverage in `container/ogg/writer_test.go` (`TestWriterWithConfig_PreservesMappingFamily` family 2+3, invalid family-3 demixing-size rejection) and `container/ogg/ogg_test.go` (family-3 OpusHead round-trip + truncated demixing-matrix parse rejection). Updated `multistream/libopus_test.go` family-3 OpusHead emission to include demixing matrices and restored `TestLibopus_AmbisonicsFamily3Matrix` execution (no skip), validating `opusinfo` family-3 metadata acceptance plus internal decode sample-count parity/energy floors. Validation: focused container+multistream ambisonics slices, full `go test ./container/ogg -count=1`, full `go test ./multistream -count=1`, and full `make verify-production` passed.
- 2026-02-16: Closed a concrete Ogg multistream mapping-family parity bug and added family-2 ambisonics libopus tooling coverage. Fixed `container/ogg/writer.go` to preserve configured `WriterConfig.MappingFamily` in emitted `OpusHead` (instead of always forcing family `1`) by introducing `DefaultOpusHeadMultistreamWithFamily` in `container/ogg/header.go`; added regression coverage `TestWriterWithConfig_PreservesMappingFamily` in `container/ogg/writer_test.go` (family 2). Expanded `multistream/libopus_test.go` with `TestLibopus_AmbisonicsFamily2Matrix`, validating family-2 Ogg headers via live `opusinfo` output (`Channel Mapping Family`, `Streams/Coupled`, channel count), internal multistream decode sample-count parity, and decode-energy floors; kept opportunistic `opusdec` decode checks as informational because `opusdec` rejects these files in this environment. Added explicit gate in `TestLibopus_AmbisonicsFamily3Matrix` documenting the remaining RFC 8486 demixing-matrix metadata gap for family 3 Ogg interoperability. Validation: focused `go test ./container/ogg -run 'TestWriterWithConfig_(Multistream|PreservesMappingFamily)' -count=1 -v`, focused multistream libopus slices including ambisonics matrix tests, full `go test ./multistream -count=1`, and full `make verify-production` passed.
- 2026-02-16: Closed multistream long-packet decode parity drift for 40ms/60ms durations and expanded libopus coverage across frame durations. Added `TestLibopus_FrameDurationMatrix` in `multistream/libopus_test.go` for stereo + 5.1 across `10/20/40/60ms`, asserting exact post-pre-skip sample counts for both libopus (`opusdec`) and internal multistream decode paths. Fixed `multistream/decoder.go` `hybridStreamDecoder` to handle multi-frame Opus packets by parsing packet frames and decoding them sequentially at valid hybrid subframe sizes (10/20ms) with reconstructed single-frame TOC, matching long-packet decode behavior expected by libopus-backed matrix tests. Validation: `go test ./multistream -run TestLibopus_FrameDurationMatrix -count=1 -v`, `go test ./multistream -run 'TestLibopus_(Stereo|51Surround|71Surround|DefaultMappingMatrix|FrameDurationMatrix|BitrateQuality|ContainerFormat|Info)' -count=1 -v`, `go test ./multistream -count=1`, `go test . -run 'TestMultistream' -count=1`, and full `make verify-production` passed.
- 2026-02-16: Closed the remaining default-mapping decode-side parity confidence gap in multistream libopus cross-validation. `TestLibopus_DefaultMappingMatrix` in `multistream/libopus_test.go` now asserts both libopus (`opusdec`) and internal multistream decoder paths return exact post-pre-skip sample counts for all default mapping-family layouts (`1..8` channels), in addition to existing libopus decode-energy checks. Validation: `go test ./multistream -run TestLibopus_DefaultMappingMatrix -count=1 -v`, `go test ./multistream -run 'TestLibopus_(Stereo|51Surround|71Surround|DefaultMappingMatrix|BitrateQuality|ContainerFormat|Info)' -count=1`, `go test ./multistream -count=1`, and full `make verify-production` passed.
- 2026-02-16: Expanded multistream libopus cross-validation coverage to all default mapping-family layouts (1..8 channels) in `multistream/libopus_test.go` via `TestLibopus_DefaultMappingMatrix`. The new guard encodes each default layout, validates Ogg/container mapping metadata path through `writeOggOpusMultistream`, decodes with live `opusdec` (libopus 1.6.1), and asserts exact post-pre-skip sample counts plus minimum decode energy retention. This closes a remaining confidence gap where cross-validation had focused on 2/6/8 channels only. Validation: `go test ./multistream -run TestLibopus_DefaultMappingMatrix -count=1 -v`, `go test ./multistream -run 'TestLibopus_(Stereo|51Surround|71Surround|DefaultMappingMatrix|BitrateQuality|ContainerFormat|Info)' -count=1 -v`, `go test ./multistream -count=1`, `go test . -run 'TestMultistreamPacket|TestRepacketizerParityWithLibopusFixture|TestMultistreamPacketPad|TestMultistreamPacketUnpad' -count=1 -v`, and full `make verify-production` passed (parity tier + bench-guard + race).
- 2026-02-16: Closed multistream packet pad/unpad parity drift after self-delimited framing port. Updated root `MultistreamPacketPad`/`MultistreamPacketUnpad` in `packet.go` to parse and re-emit RFC 6716 self-delimited subpackets for streams `0..N-2` (instead of legacy raw length-prefix assumptions), including helpers to decode/encode self-delimited packet boundaries and normalize to standard Opus packet form for per-stream `PacketPad`/`PacketUnpad`. Added focused regression coverage in `packet_multistream_padding_test.go` for 2-stream and 3-stream pad/unpad round-trips plus malformed self-delimited input rejection. Validation: `go test . -run 'TestMultistreamPacket|TestRepacketizerParityWithLibopusFixture' -count=1 -v`, `go test ./multistream -count=1`, `go test ./multistream -run 'TestLibopus_(Stereo|51Surround|71Surround|BitrateQuality)' -count=1 -v`, `go test . -run 'TestMultistream' -count=1`, and full `make verify-production` passed.
- 2026-02-16: Closed a concrete multistream interoperability parity gap with libopus by replacing non-RFC length-prefix framing with RFC 6716 Appendix B self-delimited packet framing for streams `0..N-2` and standard framing for the last stream. Added dedicated framing helpers in `multistream/framing.go`, updated encoder assembly in `multistream/encoder.go`, and updated decoder packet splitting in `multistream/stream.go` to parse self-delimited packets and normalize them for stream decoders. Tightened libopus cross-validation harness in `multistream/libopus_test.go` to treat `opusdec` textual decode errors as failures (even when exit status is zero) and fixed WAV data-chunk scan boundary handling (`offset <= len-8`) to avoid false sample parsing from truncated outputs. Updated affected multistream tests in `multistream/encoder_test.go` and `multistream/multistream_test.go` for self-delimited semantics. Validation: `go test ./multistream -run 'TestLibopus_(Stereo|51Surround|71Surround|BitrateQuality|ContainerFormat|Info)' -count=1 -v`, `go test ./multistream -count=1`, `go test . -run 'TestMultistream' -count=1 -v`, and full `make verify-production` passed (including parity tier, bench guardrails, and race).
- 2026-02-14: Ported libopus `to_celt` transition-delay semantics in `encoder/encoder.go` to close one-frame early `Hybrid->CELT` switches in SWB auto lanes. Added explicit previous-mode state (`prevMode`) and `applyCELTTransitionDelay()` so `>=10 ms` SILK/Hybrid->CELT transitions hold one packet in previous non-CELT mode while advancing next-frame mode memory to CELT, matching `opus_encoder.c` `to_celt` behavior. Added focused coverage in `encoder/mode_transition_policy_test.go` (`TestApplyCELTTransitionDelayPolicy`, `TestForcedHybridToCELTTransitionHoldsOneFrame`). Verification: `go test ./encoder -run 'TestApplyCELTTransitionDelayPolicy|TestForcedHybridToCELTTransitionHoldsOneFrame|TestModeTraceFixtureParityWithLibopus' -count=1 -v` passed with `AUTO-SWB-20ms-mono-48k/am_multisine_v1` and `AUTO-SWB-40ms-mono-48k/speech_like_v1` mode mismatch reduced to `0/50` and `0/25`; `GOPUS_TEST_TIER=parity go test ./testvectors -run TestEncoderVariantProfileParityAgainstLibopusFixture -count=1 -v` passed with `HYBRID-SWB-20ms-mono-48k/am_multisine_v1` and `HYBRID-SWB-40ms-mono-48k/speech_like_v1` now at `mismatch=0.00%`; broad gates `make verify-production` and `make bench-guard` passed.
- 2026-02-14: Closed CELT restricted-celt parity mismatch by mirroring libopus application semantics in the variants fixture harness and aligning transient overlap sourcing to libopus prefilter memory. `encodeGopusForVariantsCase()` now sets `SetLowDelay(true)` for CELT fixture rows (matching `opus_demo -e restricted-celt` zero top-level delay compensation), while HYBRID rows remain `ModeAuto`. Also switched transient/tone overlap input to `prefilterMem` tail in `celt/encode_frame.go` and `celt/hybrid_encode_helpers.go` via `fillTransientHistoryFromPrefilter()`. Outcome: former `CELT-FB-10ms-mono-64k-impulse_train_v1` ratchet failure (`gap=-0.00 < 2.01`) became parity-pass after baseline refresh; temporary diagnostics were removed. Validation: `GOPUS_TEST_TIER=parity go test ./testvectors -run 'TestEncoderVariantProfileParityAgainstLibopusFixture|TestEncoderComplianceSummary|TestEncoderCompliancePrecisionGuard' -count=1 -v`, `make verify-production`, and `make bench-guard` all passed.
- 2026-02-14: Tightened `DecodeWithFEC(packet, fec=true)` frame-size transition behavior in `decoder.go`: when recovering from provided packet LBRR, FEC granularity now follows the provided packet TOC frame size instead of stale `lastFrameSize`, preventing 40ms->20ms transitions from returning oversized PLC-only output. Added focused regression coverage in `decoder_test.go` (`TestDecodeWithFEC_FrameSizeTransitionUsesProvidedPacketGranularity`). Validation: `go test . -run 'TestDecodeWithFEC_FrameSizeTransitionUsesProvidedPacketGranularity|TestDecodeWithFEC_UsesProvidedPacketAndPreservesNormalDecode|TestDecodeFECFrame_BufferSizingUsesSingleFrame|TestDecodeWithFEC_ProvidedCELTPacketFallsBackToPLC' -count=1 -v`, `GOPUS_TEST_TIER=parity go test ./testvectors -run TestDecoderLossParityLibopusFixture -count=1 -v`, and `GOPUS_TEST_TIER=exhaustive go test ./testvectors -run TestDecoderLossStressPatternsAgainstOpusDemo -count=1 -v` passed.
- 2026-02-14: Expanded decoder loss confidence coverage with new exhaustive stress-pattern parity checks against live `opus_demo` output. Added deterministic additional loss masks (`burst3_mid`, `periodic5`, `edge_then_mid`, `doublet_stride7`) in `testvectors/decoder_loss_parity_test.go` via `TestDecoderLossStressPatternsAgainstOpusDemo`, with dedicated stress thresholds per codec family to catch regressions under denser loss while preserving realistic concealment variance. Validation: `GOPUS_TEST_TIER=exhaustive go test ./testvectors -run 'TestDecoderLossStressPatternsAgainstOpusDemo|TestDecoderLossFixtureHonestyWithOpusDemo' -count=1 -v` and `GOPUS_TEST_TIER=parity go test ./testvectors -run TestDecoderLossParityLibopusFixture -count=1 -v` passed.
- 2026-02-14: Closed a decode-fec output sizing parity gap in `decoder.go`: `decodeFECFrame` now sizes packet-loss recovery output as a single recovered frame (`frameSize * channels`) instead of `frameSize * frameCount`, matching libopus `decode_fec` semantics for packet N+1 LBRR recovery. Added focused regression coverage in `decoder_test.go` (`TestDecodeFECFrame_BufferSizingUsesSingleFrame`) to prevent multi-frame packet metadata from spuriously requiring oversized output buffers and forcing PLC fallback. Validation: `go test . -run 'TestDecodeFECFrame_BufferSizingUsesSingleFrame|TestDecodeWithFEC_UsesProvidedPacketAndPreservesNormalDecode|TestDecodeWithFEC_ProvidedCELTPacketFallsBackToPLC|TestDecodeWithFEC_NoFECRequested' -count=1 -v` and `GOPUS_TEST_TIER=parity go test ./testvectors -run TestDecoderLossParityLibopusFixture -count=1 -v` passed.
- 2026-02-14: Added libopus-backed decoder loss/FEC fixture workflow and parity guards for WebRTC-style loss recovery. Updated `decoder.go` `DecodeWithFEC` semantics to honor provided packet data when `fec=true` (decode missing frame from packet N+1 LBRR, PLC fallback when no LBRR/CELT). Added focused decoder API coverage in `decoder_test.go` (`TestDecodeWithFEC_UsesProvidedPacketAndPreservesNormalDecode`, `TestDecodeWithFEC_ProvidedCELTPacketFallsBackToPLC`). Added generator `tools/gen_libopus_decoder_loss_fixture.go`, new fixtures `testvectors/testdata/libopus_decoder_loss_fixture.json` and `testvectors/testdata/libopus_decoder_loss_fixture_amd64.json`, loader `testvectors/libopus_decoder_loss_fixture_test.go`, parity/ratchet + honesty tests `testvectors/decoder_loss_parity_test.go`, governance wiring `testvectors/fixture_governance_test.go`, and Makefile fixture/exhaustive target updates (`fixtures-gen-decoder-loss`, amd64 generation env, `TestDecoderLossFixtureHonestyWithOpusDemo` in `test-exhaustive`). Validation: focused root FEC/PLC tests, `GOPUS_TEST_TIER=parity go test ./testvectors -run 'TestDecoderLossParityLibopusFixture|TestFixtureGeneratorScriptsBuildIgnore|TestFixtureGeneratorsUseLibopusOpusDemo' -count=1 -v`, `GOPUS_TEST_TIER=exhaustive go test ./testvectors -run TestDecoderLossFixtureHonestyWithOpusDemo -count=1 -v`, and full `make verify-production` all passed.
- 2026-02-14: Added a libopus-backed frame-level mode-trace parity guard and ported short-frame (`<=20 ms`) auto mode selection to libopus threshold/hysteresis flow. New generator: `tmp_check/gen_libopus_mode_trace_fixture.go`; new fixture: `encoder/testdata/libopus_mode_trace_fixture.json` (32 cases across NB/WB/SWB/FB mono/stereo); new parity tests: `encoder/mode_trace_fixture_test.go` (`TestModeTraceFixtureParityWithLibopus`, metadata guard). Ported control flow in `encoder/encoder.go`: mode-threshold selection using analysis-driven `voice_est` + previous-mode hysteresis across short frames, shared `autoVoiceEstimate`, VoIP application bias (`+8000` threshold, fallback voice confidence), and libopus-style FEC/DTX SILK forcing conditions. Aligned wrappers/application forwarding (`encoder.go`, `multistream.go`, `multistream/encoder.go`) to set VoIP application bias explicitly. Updated FEC verification tests (`fec_lbrr_detailed_test.go`, `fec_verification_test.go`) to configure expected loss (`SetPacketLoss(15)`) so LBRR assertions run in the intended operating point. Validation: focused encoder mode-trace + auto-policy tests, focused FEC tests, parity slice (`GOPUS_TEST_TIER=parity go test ./testvectors -run 'TestEncoderVariantProfileParityAgainstLibopusFixture|TestEncoderComplianceSummary|TestEncoderCompliancePrecisionGuard' -count=1 -v`), `make verify-production`, and `make bench-guard` all passed.
- 2026-02-14: Replaced CELT constrained-VBR guardrails with libopus-style reservoir/offset flow in `celt/encode_frame.go` and `celt/encoder.go`. Removed non-libopus short/medium frame bitrate uplifts and explicit `+15%` constrained clamp, then ported constrained state cadence (`vbr_reservoir`, `vbr_offset`, `vbr_drift`, `vbr_count`) and bound handling into target-bit computation. Added configurable constrained bound scaling for multistream packet-cap parity (`encoder.SetCELTCVBRBoundScale`, `multistreamCVBRBoundScale` in `multistream/encoder.go`) so aggregate multistream CVBR bursts stay within the Opus `1275`-byte cap while preserving libopus single-stream behavior (`scale=1`). Updated CELT/stereo CVBR envelope coverage in `encoder/encoder_test.go` to assert libopus-like per-frame burst (`<=2x` base) plus near-target average. Regenerated `celt/testdata/opusdec_crossval_fixture.json` after packet-hash changes from CVBR flow. Validation: focused CVBR and crossval tests, parity/compliance slice (`TestEncoderVariantProfileParityAgainstLibopusFixture|TestEncoderComplianceSummary|TestEncoderCompliancePrecisionGuard`), `make verify-production`, and `make bench-guard` all passed.
- 2026-02-14: Tightened ModeAuto analyzer-invalid fallback to libopus behavior in `encoder/encoder.go`: removed non-libopus PCM classifier/energy-ratio fallback from `autoSignalFromPCM()` and now return `SignalAuto` when analysis is unavailable/invalid outside SWB 10/20 ms threshold lanes, so mode decisions use libopus-style default voice-estimate control instead of heuristic voice/music forcing. Added focused coverage in `encoder/auto_mode_policy_test.go` (`TestAutoSignalFromPCMAnalyzerInvalidFallsBackToAuto`, `TestAutoSignalFromPCMAnalyzerUnavailableFallsBackToAuto`) while preserving SWB threshold tests. Validation: focused encoder auto-mode/analysis reuse tests, parity/compliance slice (`TestEncoderVariantProfileParityAgainstLibopusFixture|TestEncoderComplianceSummary|TestEncoderCompliancePrecisionGuard`), `make verify-production`, and `make bench-guard` all passed.
- 2026-02-14: Completed analyzer trace fixture coverage to the full active encoder parity matrix. `tmp_check/gen_libopus_analysis_trace_fixture.go` now emits all 19 profile lanes (CELT mono/stereo, HYBRID FB/SWB mono/stereo, SILK NB/MB/WB mono/stereo including 60 ms), and regenerated `encoder/testdata/libopus_analysis_trace_fixture.json` now contains 76 cases (19 profiles x 4 variants). Added `TestAnalysisTraceFixtureProfileCoverage` in `encoder/analysis_trace_fixture_test.go` to enforce profile coverage and prevent future lane drift. Validation: `go test ./encoder -run 'TestAnalysisTraceFixtureParityWithLibopus|TestAnalysisTraceFixtureMetadata|TestAnalysisTraceFixtureProfileCoverage' -count=1 -v`, `GOPUS_TEST_TIER=parity go test ./testvectors -run 'TestEncoderVariantProfileParityAgainstLibopusFixture|TestEncoderComplianceSummary|TestEncoderCompliancePrecisionGuard' -count=1 -v`, `make verify-production`, and `make bench-guard` passed.
- 2026-02-14: Extended libopus analyzer trace fixture coverage beyond SWB mono in `tmp_check/gen_libopus_analysis_trace_fixture.go` and regenerated `encoder/testdata/libopus_analysis_trace_fixture.json`. The fixture matrix now includes stereo and long-frame profiles from active parity workloads (`HYBRID-FB-20ms-stereo-96k`, `CELT-FB-20ms-stereo-128k`, `SILK-WB-20ms-stereo-48k`, and `HYBRID-FB-60ms-mono-64k`) in addition to existing SWB mono cases. Validation: `go test ./encoder -run 'TestAnalysisTraceFixtureParityWithLibopus|TestAnalysisTraceFixtureMetadata' -count=1 -v` reported `badFrames=0` across all 36 generated cases; `GOPUS_TEST_TIER=parity go test ./testvectors -run 'TestEncoderVariantProfileParityAgainstLibopusFixture|TestEncoderComplianceSummary|TestEncoderCompliancePrecisionGuard' -count=1 -v` passed; `make verify-production` and `make bench-guard` passed.
- 2026-02-14: Ported libopus per-frame SILK VAD control cadence for multi-frame packets. `encoder/encoder.go` now captures per-20ms VAD state snapshots (speech activity, tilt, quality bands) and threads them through SILK mono/stereo packet paths; `silk/encode_frame.go` and `silk/silk_encode.go` now apply those states before each subframe encode (matching `silk_encode_do_VAD_Fxx` cadence in `tmp_check/opus-1.6.1/silk/enc_API.c`). Added regression test `silk/vad_state_packet_test.go` (`TestEncodePacketWithFECWithVADStatesUsesPerFrameState`). Validation: `go test ./silk -run TestEncodePacketWithFECWithVADStatesUsesPerFrameState -count=1 -v`, `go test ./encoder ./silk -count=1`, `GOPUS_TEST_TIER=parity go test ./testvectors -run 'TestEncoderVariantProfileParityAgainstLibopusFixture|TestEncoderComplianceSummary|TestEncoderCompliancePrecisionGuard' -count=1`, and `GOPUS_TEST_TIER=exhaustive go test ./testvectors -run TestEncoderVariantProfileProvenanceAudit -count=1 -v` passed. Provenance worst-list no longer includes prior long SILK impulse outliers (`SILK-NB-40ms`/`SILK-WB-40ms` moved out of top negatives); updated ratchet entries in `testvectors/testdata/encoder_compliance_variants_ratchet_baseline.json` to match the new source-backed packet-length profile.
- 2026-02-13: Ported libopus SILK payload max-bit budgeting semantics by reserving the Opus TOC byte from SILK `maxBits` allocation. Added `silkPayloadMaxBits()` in `encoder/controls.go`, removed pre-encode SILK `SetMaxBits(bitrateToBits(...))` in `Encode()`, and updated SILK mono/stereo paths in `encodeSILKFrame()` to use `(maxPacketBytes-1)*8` parity budgeting. Added focused regression coverage `encoder/silk_maxbits_budget_test.go` (`TestSILKMaxBitsReservesTOCByte`). Fixture impact: `SILK-MB-20ms-mono-24k/am_multisine_v1` improved from ~`gap=-0.68dB` to ~`gap=-0.09dB` in variant parity logs, with compliance summary now reporting `SILK-MB-20ms-mono-24k gap=-0.22dB`. Validation: `go test ./encoder -run 'TestSILKMaxBitsReservesTOCByte|TestSILK10msEncoderParams|TestBitrateModeGetSet|TestCBRDifferentBitrates|TestEncoder_SetBitrateMode|TestEncoder_SetVBRAndConstraint' -count=1 -v`, `GOPUS_TEST_TIER=parity go test ./testvectors -run 'TestEncoderVariantProfileParityAgainstLibopusFixture|TestEncoderComplianceSummary|TestEncoderCompliancePrecisionGuard' -count=1 -v`, and `make verify-production` passed.
- 2026-02-13: Replaced SWB 10 ms auto-mode transient scoring with direct libopus mode-threshold policy in `encoder/encoder.go`. `autoSignalFromPCM()` now routes SWB 10/20 ms auto decisions through `selectSWBAutoSignal()` (equivalent-rate + analysis-derived `voice_est`, prev-mode `music_prob_min/max`, and `-4000/+4000` hysteresis), removing the non-libopus `swb10TransientScore` path. Added focused coverage in `encoder/auto_mode_policy_test.go` (`TestSelectSWBAutoSignal10msHysteresis`, `TestAutoSignalFromPCMSWB10UsesThresholdPolicy`). Variant parity now reports `HYBRID-SWB-10ms-mono-48k/chirp_sweep_v1` at `gap=0.80dB mismatch=0.00%` (was high mismatch from transient gating), and `HYBRID-SWB-10ms-mono-48k/speech_like_v1` at `gap=-0.01dB mismatch=0.00%`. Updated ratchet floors for that corrected chirp case in both `encoder_compliance_variants_ratchet_baseline*.json`; validation: `go test ./encoder -run 'TestSelectSWBAutoSignal10msHysteresis|TestAutoSignalFromPCMSWB10UsesThresholdPolicy|TestUpdateOpusVADReusesFreshAnalysis' -count=1 -v` and `GOPUS_TEST_TIER=parity go test ./testvectors -run 'TestEncoderVariantProfileParityAgainstLibopusFixture|TestEncoderComplianceSummary|TestEncoderCompliancePrecisionGuard' -count=1 -v` passed.
- 2026-02-13: Ported libopus multistream surround energy-mask control flow into gopus stream policy + CELT dynalloc plumbing. `multistream/encoder.go` now builds per-stream masks from `surroundBandSMR` (42 bands for coupled streams, 21 for mono, cleared for LFE/non-surround) and forwards them via new `Encoder.SetCELTEnergyMask`. `encoder/encoder.go`/`celt/encoder.go` gained mask state/control surfaces; `celt/encode_frame.go` now derives `surround_dynalloc` + `surround_trim` from masks with libopus-style math and feeds dynalloc flooring before importance/offset computation. Added tests `multistream.TestEncode_SurroundEnergyMaskPerStream`, `celt.TestEncoderSetEnergyMask`, and `celt.TestComputeSurroundDynallocFromMask`. Validation: `go test ./encoder ./celt ./multistream -count=1` and parity slice `GOPUS_TEST_TIER=parity go test ./testvectors -run 'TestEncoderVariantProfileParityAgainstLibopusFixture|TestEncoderComplianceSummary|TestEncoderCompliancePrecisionGuard' -count=1` passed.
- 2026-02-13: Added libopus analyzer trace fixture workflow and closed the deferred analyzer feature-vector parity gap. New generator: `tmp_check/gen_libopus_analysis_trace_fixture.go` (build-ignore, libopus 1.6.1 `run_analysis`/`tonality_get_info`), fixture: `encoder/testdata/libopus_analysis_trace_fixture.json`, and new parity guards: `encoder/analysis_trace_fixture_test.go` (`TestAnalysisTraceFixtureParityWithLibopus`, `TestAnalysisTraceFixtureMetadata`). Ported full libopus 25-feature MLP assembly in `encoder/analysis.go` (`midE`, `spec_variability`, `cmean/mem/std` state cadence, feature slot mapping) and aligned SWB auto control thresholds in `encoder/encoder.go` (prev-mode `music_prob` min/max selection + `-4000/+4000` hysteresis). Tightened ratchet entry for `HYBRID-SWB-20ms-mono-48k/am_multisine_v1` in `testvectors/testdata/encoder_compliance_variants_ratchet_baseline.json` to reflect reduced mode mismatch after source parity. Validation: focused encoder analysis tests, `TestEncoderVariantProfileParityAgainstLibopusFixture|TestEncoderComplianceSummary|TestEncoderCompliancePrecisionGuard`, and full `make verify-production` (includes bench-guard + race) passed.
- 2026-02-13: Ported libopus analyzer phase math primitives in `encoder/analysis.go`: switched angle extraction to libopus `fast_atan2f` approximation and wrapped second-derivative phase deltas with libopus-style `float2int` semantics (ties-to-even) instead of generic `atan2` + `Round`. Added focused math coverage in `encoder/analysis_test.go` (`TestAnalysisFloat2IntRoundToEven`, `TestAnalysisFastAtan2fParityShape`). Validation: `go test ./encoder -run 'TestAnalysis|TestRunAnalysis|TestTonality' -count=1`, `go test ./testvectors -run 'TestEncoderVariantProfileParityAgainstLibopusFixture|TestEncoderComplianceSummary|TestEncoderCompliancePrecisionGuard' -count=1`, `make verify-production`, and `make bench-guard` passed.
- 2026-02-13: Re-validated deferred analyzer full-feature gate: direct full 25-feature MLP assembly wiring in `encoder/analysis.go` still regresses long-SWB mode ratchets (`HYBRID-SWB-20/40ms-*` mismatch spikes, including chirp 100% mismatch). Kept non-regressing math ports and deferred full feature wiring until analyzer trace fixtures are added for state/feature cadence parity.
- 2026-02-13: Ported analyzer LSB-depth parity in `encoder/analysis.go` and `encoder/encoder.go`: analyzer now tracks configured `LSBDepth`, uses it in libopus-style noise-floor calculation for bandwidth masking, and preserves it across `Reset()`. `Encoder.SetLSBDepth()` now propagates to analyzer state. Added coverage in `encoder/analysis_test.go` (`TestTonalityAnalysisResetPreservesLSBDepth`, `TestRunAnalysisNoiseFloorRespectsLSBDepth`, `TestEncoderSetLSBDepthPropagatesToAnalyzer`). Validation: focused encoder analysis tests, `TestEncoderVariantProfileParityAgainstLibopusFixture`, `TestEncoderComplianceSummary`, `make verify-production`, and `make bench-guard` passed.
- 2026-02-13: Ported libopus `tonality_analysis_reset()` behavior in `encoder/analysis.go`: `Reset()` now clears full reset-scoped analyzer state (angles/history/energy trackers/info queues/RNN state/downmix state) while preserving reusable configuration and scratch allocations. Added `TestTonalityAnalysisResetClearsState` in `encoder/analysis_test.go`. Validation: focused encoder analysis tests, `TestEncoderVariantProfileParityAgainstLibopusFixture`, `TestEncoderComplianceSummary`, `make verify-production`, and `make bench-guard` passed.
- 2026-02-13: Ported libopus analyzer NaN guard behavior in `encoder/analysis.go`: after FFT, if output is NaN (`out[0].r`), the current analysis slot is marked invalid and returned immediately without feature/MLP updates or counter increments, matching `analysis.c` (`info->valid = 0; return`). Added focused coverage in `encoder/analysis_test.go` (`TestRunAnalysisNaNInputMarksInfoInvalid`). Validation: focused encoder analysis tests, `TestEncoderVariantProfileParityAgainstLibopusFixture`, `TestEncoderComplianceSummary`, `make verify-production`, and `make bench-guard` passed.
- 2026-02-13: Ported libopus digital-silence handling in `tonality_analysis()`: `encoder/analysis.go` now checks the full 30 ms analysis buffer for digital silence, advances write slot, copies prior analysis info, and returns before FFT/feature/MLP updates (matching `analysis.c` control flow). Added focused coverage in `encoder/analysis_test.go` (`TestRunAnalysisSilenceCopiesPreviousInfo`, `TestRunAnalysisInitialSilenceKeepsInvalidInfo`). Validation: focused encoder analysis tests, `TestEncoderVariantProfileParityAgainstLibopusFixture`, `TestEncoderComplianceSummary`, `make verify-production`, and `make bench-guard` passed.
- 2026-02-13: Closed a concrete analyzer parity gap for 16 kHz input: `encoder/analysis.go` now ports libopus `downmix_and_resample()` behavior for `Fs==16000` (3x repeat then `silk_resampler_down2_hp` into 24 kHz analysis domain) in both initial-fill and residual paths, instead of dropping analysis updates on unsupported rate. Added focused coverage in `encoder/analysis_test.go` (`TestRunAnalysis16kProducesValidInfo`, `TestRunAnalysis16kLongFrameUses20msChunks`). Validation: focused analysis tests, `TestEncoderVariantProfileParityAgainstLibopusFixture`, `TestEncoderComplianceSummary`, `make verify-production`, and `make bench-guard` passed.
- 2026-02-13: Wired CELT prefilter `max_pitch_ratio` to libopus source of truth when analysis is valid: top-level encoder now forwards analyzer `MaxPitchRatio` into CELT analysis state, and `celt/encode_frame.go` prefers that value for `runPrefilter()` (fallback remains CELT-local estimator for standalone/invalid-analysis paths). Added focused coverage in `celt/analysis_maxpitch_test.go` (`TestSetAnalysisInfoClampsMaxPitchRatio`, `TestEncodeFrameUsesAnalysisMaxPitchRatioWhenValid`) and kept fixture parity coverage (`TestRunPrefilterParityAgainstLibopusFixture`). Validation: focused CELT tests + `TestEncoderVariantProfileParityAgainstLibopusFixture` + `TestEncoderComplianceSummary` passed.
- 2026-02-13: Ported a narrow libopus 1.6.1 analyzer math slice in `encoder/analysis.go`: added libopus-style high-band `max_pitch_ratio` tracking, `meanE`-based bandwidth masking/selection, and loudness tracker (`ETracker`/`LowECount`) updates while preserving the existing feature-vector wiring to avoid mode-ratchet regressions. Added focused coverage in `encoder/analysis_test.go` (`TestRunAnalysisMaxPitchRatioTracksHighBandEnergy`, `TestRunAnalysisLowEnergyCounterIncreasesAfterLoudnessDrop`). Validation: focused encoder analysis tests, `TestEncoderVariantProfileParityAgainstLibopusFixture`, `TestEncoderComplianceSummary`, `make verify-production`, and `make bench-guard` all passed.
- 2026-02-13: Fixed long-frame analysis residual buffering bug in `encoder/analysis.go`: when downsampled carry-over exceeded the 480-sample residual window, `MemFill` could grow beyond `AnalysisBufSize` and HP-energy carry state no longer matched retained samples. Clamped retained residual to window capacity and scaled `HPEnerAccum` to only the retained fraction. Validation: `TestEncoderVariantProfileParityAgainstLibopusFixture`, `TestEncoderComplianceSummary`, `TestEncoderCompliancePrecisionGuard`, `make verify-production`, and `make bench-guard` all passed.
- 2026-02-13: Tightened constrained-VBR policy toward libopus parity: gated custom CELT short/medium frame uplifts to unconstrained VBR only, added an explicit constrained-VBR target-bit cap (+15%) in CELT target computation, and initialized multistream stream encoders with VBR constraint enabled by default. Added regression coverage for single-stream CELT CVBR envelope (`TestBitrateModeCVBR_CELTStereoEnvelope`) and 5.1 multistream packet envelope (`TestMultistreamEncoder_CVBRPacketEnvelope`). Outcome: `TestLibopus_BitrateQuality` moved from severe overshoot/decode failures to near-target bitrates with full decode; full `make verify-production` passed.
- 2026-02-13: Fixed a concrete CVBR framing defect: `constrainSize` no longer pads undersized packets, which previously rewrote SILK packets into code-3 framing and broke TOC/libopus fixture parity. Added/updated control-transition coverage (`SetVBR`/`SetVBRConstraint`) while preserving current default VBR baseline; validated with focused encoder/multistream control tests, `TestSILKParamTraceAgainstLibopus`, `TestEncoderCompliancePrecisionGuard`, and full `make verify-production`.
- 2026-02-13: Closed libopus max-bandwidth CTL validation gap in root wrappers: `Encoder.SetMaxBandwidth` and `MultistreamEncoder.SetMaxBandwidth` now reject invalid bandwidth values with `ErrInvalidBandwidth` instead of silently accepting unknown enums. Added/updated tests in `encoder_test.go`, `multistream_test.go`, and API roundtrip coverage in `api_test.go`; `make verify-production` passed.
- 2026-02-13: Closed a concrete multistream CTL parity gap: `MultistreamEncoder.SetSignal` now mirrors libopus `OPUS_SET_SIGNAL_REQUEST` validation semantics by rejecting invalid signal values with `ErrInvalidSignal` instead of silently accepting arbitrary integers. Added coverage in `TestMultistreamEncoder_Controls` for valid voice/music transitions and invalid-value rejection. Validation: focused root/multistream control tests plus `make verify-production` (includes parity + bench-guard + race) passed.
- 2026-02-13: Compacted planning docs to reduce context load; full history archived in `.planning/archive/ACTIVE_2026-02-13_full.txt`, `.planning/archive/DECISIONS_2026-02-13_full.txt`, and `.planning/archive/WORK_CLAIMS_2026-02-13_full.txt`.
- 2026-02-13: Closed delay-compensation parity gap by gating on low-delay application state instead of forced CELT mode; focused tests + `make verify-production` + `make bench-guard` passed.
- 2026-02-13: Closed multistream application forwarding parity by propagating application policy to all stream encoders without clobbering bitrate/complexity.
- 2026-02-13: Closed lookahead and application-change lock parity in root wrappers to match libopus first-frame and low-delay behavior.
- 2026-02-12 to 2026-02-13: Completed surround trim producer flow, LFE-aware multistream policy, per-stream surround control policy, CTL/API surfaces, repacketizer parity fixture coverage, and ambisonics parity guards.
