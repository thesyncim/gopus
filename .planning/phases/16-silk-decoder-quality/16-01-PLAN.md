---
phase: 16-silk-decoder-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/testvectors/silk_baseline_test.go
  - .planning/phases/16-silk-decoder-quality/16-BASELINE.md
autonomous: true

must_haves:
  truths:
    - "SILK-only test vectors (02, 03, 04) Q scores are documented post-DecodeBit fix"
    - "New baseline Q scores show improvement from Q=-100"
    - "Test identifies whether SILK passes Q >= 0 threshold"
    - "Gap analysis documents any remaining SILK-specific issues"
  artifacts:
    - path: "internal/testvectors/silk_baseline_test.go"
      provides: "SILK-specific compliance tests with detailed output analysis"
      exports: ["TestSILKBaseline", "TestSILKFrameAnalysis"]
    - path: ".planning/phases/16-silk-decoder-quality/16-BASELINE.md"
      provides: "Post-DecodeBit fix baseline documentation"
      contains: "Q scores for testvector02, testvector03, testvector04"
  key_links:
    - from: "internal/testvectors/silk_baseline_test.go"
      to: "internal/testvectors/compliance_test.go"
      via: "shared test utilities (ReadBitstreamFile, ComputeQuality)"
      pattern: "ComputeQuality|ReadBitstreamFile"
---

<objective>
Establish new SILK decoder quality baseline after the DecodeBit fix (commit 1eceab2).

Purpose: The DecodeBit() threshold bug caused all frames to be treated as silence (Q=-100).
The fix is now in place. This plan verifies the fix's impact on SILK-only test vectors and
documents whether Phase 16 needs additional gap closure work or is complete.

Output: Baseline document with Q scores and gap analysis for SILK-only vectors.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-silk-decoder-quality/16-RESEARCH.md
@.planning/phases/15-celt-decoder-quality/15-11-SUMMARY.md
@internal/testvectors/compliance_test.go
@internal/rangecoding/decoder.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SILK-focused baseline test</name>
  <files>internal/testvectors/silk_baseline_test.go</files>
  <action>
Create a focused test file for SILK-only test vectors (02, 03, 04) that:

1. TestSILKBaseline - Run SILK-only vectors with detailed reporting:
   - Parse packets and verify they are SILK mode (config 0-11)
   - Decode all packets, track any decode errors
   - Compute Q scores against both .dec and m.dec references
   - Log energy analysis (decoded vs reference energy ratio)
   - Report sample-by-sample divergence analysis for first 100 samples if Q < 0

2. TestSILKFrameAnalysis - Analyze first frame of each vector:
   - Decode single frame and compare with reference
   - Log decoded amplitude statistics (min, max, mean, stddev)
   - Log reference amplitude statistics
   - Identify if output is all zeros (indicates silence path still taken)
   - If non-zero, compare waveform correlation

Use existing test utilities from compliance_test.go:
- ReadBitstreamFile for packet parsing
- ComputeQuality for Q metric
- readPCMFile for reference loading

Test should output clear pass/fail for each vector with actionable diagnostics.
  </action>
  <verify>
```bash
cd /Users/thesyncim/GolandProjects/gopus && go test -v -run TestSILKBaseline ./internal/testvectors/
```
Test compiles and runs, outputs Q scores for testvector02, 03, 04.
  </verify>
  <done>SILK baseline test exists, runs successfully, reports Q scores for all 3 SILK-only vectors.</done>
</task>

<task type="auto">
  <name>Task 2: Document baseline and gap analysis</name>
  <files>.planning/phases/16-silk-decoder-quality/16-BASELINE.md</files>
  <action>
Run the baseline test and create 16-BASELINE.md documenting:

1. **Pre-Fix Reference** (from research):
   - testvector02: Q=-100.00 (before DecodeBit fix)
   - testvector03: Q=-100.00
   - testvector04: Q=-100.00

2. **Post-Fix Baseline** (from test run):
   - testvector02: Q=? (actual measured value)
   - testvector03: Q=?
   - testvector04: Q=?
   - Improvement delta for each

3. **Pass/Fail Status**:
   - For each vector: Q >= 0 ? PASS : FAIL
   - Overall SILK compliance status

4. **Gap Analysis** (if any vectors fail Q >= 0):
   - First divergence point (sample index)
   - Energy ratio (decoded/reference)
   - Symptoms: zeros, wrong amplitude, wrong phase, etc.
   - Suspected cause from RESEARCH.md pitfall list

5. **Phase 16 Status**:
   - If all SILK vectors pass: "Phase 16 COMPLETE - DecodeBit fix resolved SILK issues"
   - If any fail: "Gap closure needed" with specific investigation areas

Format as markdown with tables for easy comparison.
  </action>
  <verify>
File exists at .planning/phases/16-silk-decoder-quality/16-BASELINE.md with:
- Pre-fix and post-fix Q scores for all 3 vectors
- Pass/fail determination
- Phase completion status
  </verify>
  <done>Baseline document created with measured Q scores, comparison with pre-fix values, and clear phase status determination.</done>
</task>

<task type="auto">
  <name>Task 3: Update STATE.md with baseline results</name>
  <files>.planning/STATE.md</files>
  <action>
Update STATE.md to reflect Phase 16 progress:

1. Update "Current Position" section:
   - Phase: 16 of 18 (SILK Decoder Quality)
   - Plan: 01 of ? in current phase
   - Status: Based on test results - either "Complete" or "Gap closure needed"

2. Update "Known Gaps" section:
   - If SILK passes: Remove "SILK encoder low signal energy" gap
   - If SILK fails: Update with specific findings from baseline

3. Add decision if phase is complete:
   - D16-01-01: "DecodeBit fix resolved SILK Q=-100" (if passes)
   - OR D16-01-01: "[Specific finding]" (if fails, what was found)

4. Update "Pending Todos":
   - Remove "Fix DecodeBit" todo (already done)
   - Add specific SILK todos if gaps remain
  </action>
  <verify>
STATE.md updated with Phase 16 position and status reflecting actual test results.
  </verify>
  <done>STATE.md reflects Phase 16 baseline results and phase status.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `go test -v -run TestSILK ./internal/testvectors/` passes
2. 16-BASELINE.md exists with measured Q scores
3. STATE.md reflects current Phase 16 status
4. Clear determination of whether additional plans are needed
</verification>

<success_criteria>
- SILK-only test vectors (02, 03, 04) have documented Q scores post-DecodeBit fix
- Baseline shows improvement from pre-fix Q=-100
- Clear pass/fail determination per vector
- Phase status is determined: complete OR gap closure plans identified
</success_criteria>

<output>
After completion, create `.planning/phases/16-silk-decoder-quality/16-01-SUMMARY.md`

If all SILK vectors pass Q >= 0:
- Phase 16 is COMPLETE
- Update ROADMAP.md to mark Phase 16 done
- Proceed to Phase 17 (Hybrid Decoder & Compliance)

If any SILK vectors fail:
- Create gap closure plans (16-02, 16-03, etc.) based on 16-BASELINE.md findings
- Use RESEARCH.md pitfall areas as investigation guides
</output>
