---
phase: 02-silk-decoder
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/silk/tables.go
  - internal/silk/codebook.go
  - internal/silk/decoder.go
  - internal/silk/bandwidth.go
autonomous: true

must_haves:
  truths:
    - "SILK decoder struct can be instantiated with proper initial state"
    - "Bandwidth configurations (NB/MB/WB) return correct LPC order and sample rates"
    - "ICDF tables are accessible for range decoder symbol extraction"
    - "Codebook tables are accessible for LSF/LTP reconstruction"
  artifacts:
    - path: "internal/silk/tables.go"
      provides: "All ICDF probability tables (~47 tables)"
      contains: "icdfFrameType"
    - path: "internal/silk/codebook.go"
      provides: "LSF and LTP codebook tables (~20 tables)"
      contains: "lsfCodebookNB"
    - path: "internal/silk/decoder.go"
      provides: "Decoder struct with state management"
      exports: ["Decoder", "NewDecoder"]
    - path: "internal/silk/bandwidth.go"
      provides: "Bandwidth configuration constants"
      contains: "BandwidthConfig"
  key_links:
    - from: "internal/silk/decoder.go"
      to: "internal/silk/bandwidth.go"
      via: "bandwidth config lookup"
      pattern: "bandwidthConfigs\\[bandwidth\\]"
    - from: "internal/silk/decoder.go"
      to: "internal/rangecoding"
      via: "import for range decoder"
      pattern: "rangecoding\\.Decoder"
---

<objective>
Create the SILK decoder foundation: all probability tables (ICDF), codebook tables (LSF/LTP), bandwidth configurations, and the stateful decoder struct.

Purpose: SILK decoding requires extensive lookup tables for entropy decoding and signal reconstruction. These tables are fixed per RFC 6716 Section 4.2. The decoder struct maintains frame-to-frame state for proper speech continuity.

Output: `internal/silk/` package with tables.go, codebook.go, bandwidth.go, and decoder.go providing the foundation for parameter decoding and synthesis.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-silk-decoder/02-RESEARCH.md

# Foundation from Phase 01
@internal/rangecoding/decoder.go
@packet.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SILK ICDF probability tables</name>
  <files>internal/silk/tables.go</files>
  <action>
Create `internal/silk/tables.go` with all ICDF probability tables required for SILK parameter decoding per RFC 6716 Section 4.2.

Tables to include (reference pion/opus internal/silk/icdf.go for exact values):

**Frame type tables:**
- `icdfFrameTypeVADInactive` - inactive frame types
- `icdfFrameTypeVADActive` - active frame types (signal type + quant offset)

**Gain tables:**
- `icdfGainMSBInactive`, `icdfGainMSBUnvoiced`, `icdfGainMSBVoiced` - gain MSB by signal type
- `icdfGainLSB` - gain LSB
- `icdfDeltaGain` - delta gain between subframes

**LSF tables (Stage 1):**
- `icdfLSFStage1NBMBVoiced`, `icdfLSFStage1NBMBUnvoiced` - NB/MB bandwidth
- `icdfLSFStage1WBVoiced`, `icdfLSFStage1WBUnvoiced` - WB bandwidth

**LSF tables (Stage 2):**
- `icdfLSFStage2NBMB[8]` - 8 codebooks for NB/MB
- `icdfLSFStage2WB[8]` - 8 codebooks for WB
- `icdfLSFInterpolation` - interpolation index

**Pitch/LTP tables:**
- `icdfPitchLagNB`, `icdfPitchLagMB`, `icdfPitchLagWB` - pitch lag MSB by bandwidth
- `icdfPitchContourNB`, `icdfPitchContourMB`, `icdfPitchContourWB` - contour indices
- `icdfLTPFilterIndex` - LTP filter periodicity (3 variants)
- `icdfLTPGain` - LTP gain index

**Excitation tables:**
- `icdfExcitationPulseCount` - pulse count per shell
- `icdfExcitationSplit` - binary split for shell coding
- `icdfExcitationLSB` - LSB for pulse magnitudes
- `icdfExcitationSign[42]` - sign tables (3 signal types x 2 quant x 7 pulse counts)

**Other:**
- `icdfVADFlag` - VAD flag decoding
- `icdfLBRRFlag` - LBRR flag decoding

Each table is `[]uint8` starting at 256 and decreasing to 0. Include doc comments citing RFC 6716 section numbers.

Note: Tables can be verified against pion/opus (MIT licensed) but do not copy verbatim - transcribe from RFC.
  </action>
  <verify>
`go build ./internal/silk/` compiles successfully.
Spot-check: `icdfFrameTypeVADActive` has 5 elements (256, ~230, ~166, ~128, 0).
  </verify>
  <done>All ~47 ICDF tables defined in tables.go with RFC section references in comments.</done>
</task>

<task type="auto">
  <name>Task 2: Create SILK codebook tables</name>
  <files>internal/silk/codebook.go</files>
  <action>
Create `internal/silk/codebook.go` with all codebook tables for LSF and LTP reconstruction per RFC 6716 Section 4.2.7.

Tables to include:

**LSF Stage 1 codebooks (Q8 format):**
- `lsfCodebookNBMB` - [32][10]uint8 for NB/MB (10 coefficients, 32 vectors)
- `lsfCodebookWB` - [32][16]uint8 for WB (16 coefficients, 32 vectors)

**LSF Stage 2 residual codebooks:**
- `lsfStage2ResNBMB` - [8][32][10]int8 for NB/MB (8 maps, 32 vectors, 10 coeffs)
- `lsfStage2ResWB` - [8][32][16]int8 for WB (8 maps, 32 vectors, 16 coeffs)

**LSF prediction weights:**
- `lsfPredWeightsNBMB` - [2][9]uint8 (2 orderings, 9 weights for d_LPC=10)
- `lsfPredWeightsWB` - [2][15]uint8 (2 orderings, 15 weights for d_LPC=16)

**LSF weight selection:**
- `lsfWeightSelectNBMB` - [32][9]uint8 (which weight set per codebook entry)
- `lsfWeightSelectWB` - [32][15]uint8

**LTP filter codebooks (Q7 format):**
- `ltpFilterNBMB` - [3][][5]int8 - 3 periodicity variants (8, 16, 32 entries x 5 taps)
- `ltpFilterWB` - same structure

**Pitch contour codebooks:**
- `pitchContourNB10ms`, `pitchContourNB20ms` - [16][2]int8 and [16][4]int8
- `pitchContourMB10ms`, `pitchContourMB20ms` - [4][2]int8 and [4][4]int8
- `pitchContourWB10ms`, `pitchContourWB20ms` - [4][2]int8 and [4][4]int8

**LSF stability:**
- `lsfMinSpacingNBMB` - [11]int minimum spacing between LSF coefficients
- `lsfMinSpacingWB` - [17]int
- `lsfOrderingNBMB` - [10]uint8 ordering indices
- `lsfOrderingWB` - [16]uint8

**Math tables:**
- `cosineTable` - [129]int32 (Q12) for LSF-to-LPC conversion

Include RFC 6716 table references in comments.
  </action>
  <verify>
`go build ./internal/silk/` compiles successfully.
Spot-check: `lsfCodebookNBMB[0]` has 10 elements, `lsfCodebookWB[0]` has 16 elements.
  </verify>
  <done>All ~20 codebook tables defined with correct dimensions matching RFC 6716.</done>
</task>

<task type="auto">
  <name>Task 3: Create bandwidth config and decoder struct</name>
  <files>internal/silk/bandwidth.go, internal/silk/decoder.go</files>
  <action>
**Part A: Create `internal/silk/bandwidth.go`**

Define bandwidth configuration:

```go
package silk

// Bandwidth represents SILK audio bandwidth.
type Bandwidth uint8

const (
    BandwidthNarrowband  Bandwidth = iota // 8kHz sample rate
    BandwidthMediumband                   // 12kHz sample rate
    BandwidthWideband                     // 16kHz sample rate
)

// BandwidthConfig holds bandwidth-dependent parameters.
type BandwidthConfig struct {
    SampleRate      int // 8000, 12000, or 16000
    LPCOrder        int // 10 for NB/MB, 16 for WB
    SubframeSamples int // Samples per 5ms subframe
    PitchLagMin     int // Minimum pitch lag
    PitchLagMax     int // Maximum pitch lag
}

var bandwidthConfigs = map[Bandwidth]BandwidthConfig{
    BandwidthNarrowband:  {8000, 10, 40, 16, 144},
    BandwidthMediumband:  {12000, 10, 60, 24, 216},
    BandwidthWideband:    {16000, 16, 80, 32, 288},
}

func GetBandwidthConfig(bw Bandwidth) BandwidthConfig {
    return bandwidthConfigs[bw]
}
```

**Part B: Create `internal/silk/decoder.go`**

Define the SILK decoder struct with all state needed for frame-to-frame persistence:

```go
package silk

import "github.com/user/gopus/internal/rangecoding"

// Decoder decodes SILK frames from an Opus packet.
type Decoder struct {
    // Range decoder reference (set per frame)
    rangeDecoder *rangecoding.Decoder

    // Frame state (persists across frames)
    haveDecoded           bool      // True after first frame
    previousLogGain       int32     // Last subframe gain (for delta)
    isPreviousFrameVoiced bool      // Was previous frame voiced

    // LPC state (persists across frames)
    lpcOrder              int       // Current LPC order (10 or 16)
    prevLPCValues         []float32 // d_LPC output history

    // LSF state (persists for interpolation)
    prevLSFQ15            []int16   // Previous frame LSF coefficients

    // Excitation/output history (for LTP lookback)
    outputHistory         []float32 // Ring buffer, min 306 samples for max pitch lag
    historyIndex          int       // Current write position

    // Stereo state
    prevStereoWeights     [2]int16  // Previous w0, w1 (Q13)
}

// NewDecoder creates a new SILK decoder.
func NewDecoder() *Decoder {
    return &Decoder{
        prevLPCValues: make([]float32, 16),  // Max for WB
        prevLSFQ15:    make([]int16, 16),    // Max for WB
        outputHistory: make([]float32, 322), // Max pitch lag (288) + LTP taps (5) + margin
    }
}

// Reset clears decoder state for a new stream.
func (d *Decoder) Reset() {
    d.haveDecoded = false
    d.previousLogGain = 0
    d.isPreviousFrameVoiced = false
    d.lpcOrder = 0
    for i := range d.prevLPCValues {
        d.prevLPCValues[i] = 0
    }
    for i := range d.prevLSFQ15 {
        d.prevLSFQ15[i] = 0
    }
    for i := range d.outputHistory {
        d.outputHistory[i] = 0
    }
    d.historyIndex = 0
    d.prevStereoWeights = [2]int16{0, 0}
}

// SetRangeDecoder sets the range decoder for the current frame.
func (d *Decoder) SetRangeDecoder(rd *rangecoding.Decoder) {
    d.rangeDecoder = rd
}
```

Ensure the import path matches the actual module path in go.mod.
  </action>
  <verify>
`go build ./internal/silk/` compiles with no errors.
`go doc ./internal/silk/` shows Decoder, NewDecoder, BandwidthConfig exports.
  </verify>
  <done>
Bandwidth config returns correct values: NB has LPCOrder=10, WB has LPCOrder=16.
Decoder struct has all required state fields for frame persistence.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `go build ./...` - entire project compiles
2. `go test ./internal/rangecoding/` - existing tests still pass
3. `ls internal/silk/` shows tables.go, codebook.go, bandwidth.go, decoder.go
4. Table count verification: grep for `icdf` should show ~40+ table definitions
</verification>

<success_criteria>
- internal/silk/ package exists and compiles
- All ICDF tables defined (~47 tables for probability decoding)
- All codebook tables defined (~20 tables for LSF/LTP reconstruction)
- Bandwidth configs return correct LPC order: NB/MB=10, WB=16
- Decoder struct has state fields: previousLogGain, prevLPCValues, prevLSFQ15, outputHistory
- No cgo dependencies (`go list -f '{{.CgoFiles}}' ./...` returns empty)
</success_criteria>

<output>
After completion, create `.planning/phases/02-silk-decoder/02-01-SUMMARY.md`
</output>
