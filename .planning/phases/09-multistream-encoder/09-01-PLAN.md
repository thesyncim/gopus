---
phase: 09-multistream-encoder
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/multistream/encoder.go
  - internal/multistream/encoder_test.go
autonomous: true

must_haves:
  truths:
    - "MultistreamEncoder creates successfully for valid channel counts (1-8)"
    - "Creation fails with clear error for invalid configurations"
    - "Input channels route correctly to stream buffers"
    - "Coupled streams receive stereo encoders, uncoupled receive mono"
  artifacts:
    - path: "internal/multistream/encoder.go"
      provides: "Encoder struct, NewEncoder, routeChannelsToStreams"
      min_lines: 150
    - path: "internal/multistream/encoder_test.go"
      provides: "Creation and routing tests"
      exports: ["TestNewEncoder", "TestRouteChannelsToStreams"]
  key_links:
    - from: "internal/multistream/encoder.go"
      to: "internal/encoder/encoder.go"
      via: "encoder.NewEncoder composition"
      pattern: "encoder\\.NewEncoder"
    - from: "internal/multistream/encoder.go"
      to: "internal/multistream/mapping.go"
      via: "DefaultMapping, resolveMapping reuse"
      pattern: "(DefaultMapping|resolveMapping)"
---

<objective>
Create the MultistreamEncoder foundation with struct definition, creation function, and channel routing logic.

Purpose: Establish encoder architecture that mirrors Phase 5 decoder and composes Phase 8 unified Encoders for each stream.
Output: Working encoder creation with validation and channel routing (inverse of applyChannelMapping).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-multistream-encoder/09-CONTEXT.md
@.planning/phases/09-multistream-encoder/09-RESEARCH.md
@internal/multistream/decoder.go
@internal/multistream/mapping.go
@internal/encoder/encoder.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MultistreamEncoder struct and NewEncoder function</name>
  <files>internal/multistream/encoder.go</files>
  <action>
Create `internal/multistream/encoder.go` with:

1. **Encoder struct** (mirrors Decoder):
```go
type Encoder struct {
    sampleRate     int              // 8000, 12000, 16000, 24000, 48000
    inputChannels  int              // Total input channels (1-255)
    streams        int              // Total streams (N)
    coupledStreams int              // Coupled stereo streams (M)
    mapping        []byte           // Channel mapping table
    encoders       []*encoder.Encoder  // One encoder per stream
    bitrate        int              // Total bitrate, distributed across streams
}
```

2. **NewEncoder function** with validation matching decoder exactly:
- channels: 1-255, return ErrInvalidChannels
- streams: 1-255, return ErrInvalidStreams
- coupledStreams: 0 to streams, return ErrInvalidCoupledStreams
- streams + coupledStreams <= 255, return ErrTooManyChannels
- len(mapping) == channels, return ErrInvalidMapping
- mapping values: 0 to streams+coupledStreams-1 or 255, return ErrInvalidMapping

3. **Create stream encoders**:
- First M encoders: stereo (channels=2) using encoder.NewEncoder(sampleRate, 2)
- Remaining N-M encoders: mono (channels=1) using encoder.NewEncoder(sampleRate, 1)

4. **Helper functions**:
- NewEncoderDefault(sampleRate, channels int) for standard Vorbis configurations
- Uses DefaultMapping() to get streams, coupledStreams, mapping

Reuse existing error variables from decoder.go (they're package-level). Import "gopus/internal/encoder".
  </action>
  <verify>
Run `go build ./internal/multistream/` - must compile without errors.
Run `go vet ./internal/multistream/` - no issues.
  </verify>
  <done>
Encoder struct defined with all fields matching decoder pattern. NewEncoder validates identically to NewDecoder. NewEncoderDefault creates default configurations for 1-8 channels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement channel routing (inverse of applyChannelMapping)</name>
  <files>internal/multistream/encoder.go</files>
  <action>
Add routeChannelsToStreams function - the inverse of applyChannelMapping:

```go
// routeChannelsToStreams routes interleaved input to stream buffers.
// This is the inverse of applyChannelMapping in multistream.go.
//
// Input format: sample-interleaved [ch0_s0, ch1_s0, ..., chN_s0, ch0_s1, ...]
// Output: slice of buffers, one per stream (stereo streams interleaved)
func routeChannelsToStreams(
    input []float64,
    mapping []byte,
    coupledStreams int,
    frameSize int,
    inputChannels int,
    numStreams int,
) [][]float64 {
    // Create buffer for each stream
    streamBuffers := make([][]float64, numStreams)
    for i := 0; i < numStreams; i++ {
        chans := streamChannels(i, coupledStreams)
        streamBuffers[i] = make([]float64, frameSize*chans)
    }

    // Route input channels to appropriate streams
    // Key insight: mapping[outCh] tells us which stream channel feeds outCh
    // For encoding, we invert: find which output channel maps to each stream
    for outCh := 0; outCh < inputChannels; outCh++ {
        mappingIdx := mapping[outCh]
        if mappingIdx == 255 {
            continue // Silent channel, skip
        }

        streamIdx, chanInStream := resolveMapping(mappingIdx, coupledStreams)
        if streamIdx < 0 || streamIdx >= numStreams {
            continue
        }

        srcChannels := streamChannels(streamIdx, coupledStreams)

        // Copy samples from input channel to stream buffer
        for s := 0; s < frameSize; s++ {
            streamBuffers[streamIdx][s*srcChannels+chanInStream] = input[s*inputChannels+outCh]
        }
    }

    return streamBuffers
}
```

Note: This reuses resolveMapping and streamChannels from mapping.go.
  </action>
  <verify>
Run `go build ./internal/multistream/` - must compile without errors.
  </verify>
  <done>
routeChannelsToStreams correctly inverts applyChannelMapping. Reuses existing mapping.go helpers.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add creation and routing unit tests</name>
  <files>internal/multistream/encoder_test.go</files>
  <action>
Create `internal/multistream/encoder_test.go` with tests:

1. **TestNewEncoder** - validation tests:
- Valid mono (1 channel, 1 stream, 0 coupled)
- Valid stereo (2 channels, 1 stream, 1 coupled)
- Valid 5.1 (6 channels, 4 streams, 2 coupled)
- Valid 7.1 (8 channels, 5 streams, 3 coupled)
- Invalid: channels = 0 -> ErrInvalidChannels
- Invalid: channels = 256 -> ErrInvalidChannels
- Invalid: streams = 0 -> ErrInvalidStreams
- Invalid: coupledStreams > streams -> ErrInvalidCoupledStreams
- Invalid: streams + coupled > 255 -> ErrTooManyChannels
- Invalid: mapping too short -> ErrInvalidMapping
- Invalid: mapping value >= streams+coupled -> ErrInvalidMapping

2. **TestNewEncoderDefault** - standard configurations:
- 1 channel -> mono
- 2 channels -> stereo
- 6 channels -> 5.1
- 8 channels -> 7.1
- Invalid: 9 channels -> ErrUnsupportedChannels

3. **TestRouteChannelsToStreams** - routing correctness:
- Mono: single channel routes to single mono stream
- Stereo: L/R route to coupled stream as interleaved
- 5.1: verify FL/FR -> stream 0, RL/RR -> stream 1, C -> stream 2, LFE -> stream 3
- Silent channel (255): verify zeros in stream

4. **TestRouteChannelsToStreams_RoundTrip**:
- Create input, route to streams, apply applyChannelMapping back
- Verify output matches input (proves routing is correct inverse)
  </action>
  <verify>
Run `go test -v ./internal/multistream/ -run 'TestNewEncoder|TestNewEncoderDefault|TestRouteChannels'` - all tests pass.
  </verify>
  <done>
All creation tests pass. All routing tests pass. Round-trip test proves routing is correct inverse of applyChannelMapping.
  </done>
</task>

</tasks>

<verification>
- [ ] `go build ./internal/multistream/` compiles
- [ ] `go test ./internal/multistream/ -run 'TestNewEncoder|TestRouteChannels'` passes
- [ ] Encoder struct matches decoder pattern
- [ ] NewEncoder validation matches NewDecoder validation
- [ ] routeChannelsToStreams is inverse of applyChannelMapping
</verification>

<success_criteria>
- MultistreamEncoder struct defined with Phase 8 Encoder composition
- NewEncoder validates identically to NewDecoder
- NewEncoderDefault handles standard 1-8 channel configurations
- routeChannelsToStreams correctly routes input to stream buffers
- All unit tests pass demonstrating correct creation and routing
</success_criteria>

<output>
After completion, create `.planning/phases/09-multistream-encoder/09-01-SUMMARY.md`
</output>
