---
phase: 07-celt-encoder
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/celt/encoder.go
  - internal/celt/mdct_encode.go
  - internal/celt/preemph.go
  - internal/celt/encoder_test.go
autonomous: true

must_haves:
  truths:
    - "CELT encoder struct mirrors decoder state for synchronized prediction"
    - "Forward MDCT produces frequency coefficients from time samples"
    - "MDCT -> IMDCT round-trip reconstructs original signal (without quantization)"
    - "Pre-emphasis filter prepares audio for MDCT analysis"
  artifacts:
    - path: "internal/celt/encoder.go"
      provides: "Encoder struct with state mirroring decoder"
      exports: ["Encoder", "NewEncoder", "Reset"]
    - path: "internal/celt/mdct_encode.go"
      provides: "Forward MDCT transform"
      exports: ["MDCT", "MDCTShort"]
    - path: "internal/celt/preemph.go"
      provides: "Pre-emphasis filter"
      exports: ["ApplyPreemphasis"]
  key_links:
    - from: "internal/celt/encoder.go"
      to: "internal/rangecoding/encoder.go"
      via: "rangeEncoder field"
      pattern: "rangecoding\\.Encoder"
    - from: "internal/celt/mdct_encode.go"
      to: "internal/celt/mdct.go"
      via: "MDCT is transpose of IMDCT"
      pattern: "IMDCT.*spectrum"
---

<objective>
Create the CELT encoder foundation: encoder struct, forward MDCT, and pre-emphasis filter.

Purpose: Establish the encoding infrastructure that mirrors the Phase 3 decoder. The encoder struct maintains state for inter-frame prediction (energy, overlap). Forward MDCT converts time-domain samples to frequency-domain coefficients for quantization.

Output: Encoder struct, MDCT function, pre-emphasis filter, with MDCT->IMDCT round-trip tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-celt-encoder/07-RESEARCH.md

# Phase 3 decoder for reference
@internal/celt/decoder.go
@internal/celt/mdct.go
@internal/celt/tables.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CELT Encoder struct</name>
  <files>internal/celt/encoder.go</files>
  <action>
Create Encoder struct mirroring Decoder state from decoder.go:

```go
type Encoder struct {
    // Range encoder reference (set per frame)
    rangeEncoder *rangecoding.Encoder

    // Configuration (mirrors decoder)
    channels   int
    sampleRate int // Always 48000

    // Energy state (persists across frames, mirrors decoder)
    prevEnergy  []float64 // Previous frame band energies [MaxBands * channels]
    prevEnergy2 []float64 // Two frames ago

    // Synthesis state for overlap (mirrors decoder)
    overlapBuffer []float64 // MDCT overlap [Overlap * channels]
    preemphState  []float64 // Pre-emphasis filter state [channels]

    // RNG state (for deterministic folding decisions)
    rng uint32

    // Analysis buffers (encoder-specific)
    inputBuffer []float64 // Input sample lookahead
    mdctBuffer  []float64 // MDCT output
}
```

Implement:
- `NewEncoder(channels int) *Encoder` - mirrors NewDecoder exactly
- `Reset()` - clears all state
- `SetRangeEncoder(re *rangecoding.Encoder)`
- Getters for state: Channels(), SampleRate(), PrevEnergy(), etc.
- `SetPrevEnergy(energies []float64)` - shifts prev to prev2, sets new prev

Use same initial values as decoder (D03-01-01, D03-01-02):
- prevEnergy initialized to -28.0 (low but finite)
- rng seed 22222
  </action>
  <verify>File compiles: `go build ./internal/celt/`</verify>
  <done>Encoder struct exists with state mirroring decoder, NewEncoder creates properly initialized instance</done>
</task>

<task type="auto">
  <name>Task 2: Implement forward MDCT</name>
  <files>internal/celt/mdct_encode.go</files>
  <action>
Implement forward MDCT (time to frequency transform) in mdct_encode.go.

The forward MDCT is the transpose of IMDCT:
- Input: 2N time samples (windowed)
- Output: N frequency coefficients

Formula: X[k] = sum_{n=0}^{2N-1} x[n] * cos(pi/N * (n + 0.5 + N/2) * (k + 0.5))

Implement:

1. `MDCT(samples []float64) []float64` - forward MDCT
   - Takes 2*N samples, returns N coefficients
   - Apply Vorbis window from window.go (same as decoder)
   - Direct computation initially (can optimize later)
   - Normalization: no additional scaling needed (IMDCT has 2/N)

2. `MDCTShort(samples []float64, shortBlocks int) []float64` - for transient frames
   - Process multiple short blocks
   - Interleave coefficients same way decoder expects

Use existing VorbisWindow from window.go for windowing.

Key: MDCT -> IMDCT should reconstruct original (with overlap-add).
  </action>
  <verify>`go build ./internal/celt/` compiles without errors</verify>
  <done>Forward MDCT implemented, produces N coefficients from 2N samples</done>
</task>

<task type="auto">
  <name>Task 3: Implement pre-emphasis and tests</name>
  <files>internal/celt/preemph.go, internal/celt/encoder_test.go</files>
  <action>
1. Create preemph.go with pre-emphasis filter:

```go
// ApplyPreemphasis applies the pre-emphasis filter to PCM input.
// Pre-emphasis: y[n] = x[n] - PreemphCoef * x[n-1]
// This is the inverse of decoder's de-emphasis.
func (e *Encoder) ApplyPreemphasis(pcm []float64) []float64
```

Uses PreemphCoef = 0.85 from tables.go (D03-05-03).
Maintains state in e.preemphState for frame continuity.

2. Create encoder_test.go with tests:

a) TestNewEncoder - verify initialization matches decoder
b) TestMDCTRoundTrip - MDCT -> IMDCT reconstructs original
   - Create sine wave input (2*N samples)
   - Apply MDCT to get N coefficients
   - Apply IMDCT to get 2*N samples back
   - Verify output matches input (within tolerance for windowing overlap)

c) TestPreemphasisDeemphasis - pre-emphasis -> de-emphasis round-trip
   - Apply pre-emphasis
   - Apply de-emphasis (using decoder's applyDeemphasis logic)
   - Verify reconstruction

d) TestMDCTShortRoundTrip - test with 2, 4, 8 short blocks
  </action>
  <verify>`go test ./internal/celt/ -run "Encoder|MDCT.*Round|Preemph" -v` passes</verify>
  <done>Pre-emphasis implemented, MDCT->IMDCT round-trip verified, all tests pass</done>
</task>

</tasks>

<verification>
After all tasks:
1. `go build ./internal/celt/` - compiles without errors
2. `go test ./internal/celt/ -v` - all tests pass including new encoder tests
3. MDCT -> IMDCT round-trip produces matching output (verify in test)
4. Pre-emphasis -> de-emphasis round-trip reconstructs original
</verification>

<success_criteria>
- Encoder struct mirrors Decoder state (same fields for energy, overlap, preemph)
- NewEncoder initializes with same defaults as NewDecoder
- Forward MDCT produces correct frequency coefficients
- MDCT -> IMDCT round-trip works (tested)
- Pre-emphasis filter implemented and tested
- All existing CELT decoder tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-celt-encoder/07-01-SUMMARY.md`
</output>
