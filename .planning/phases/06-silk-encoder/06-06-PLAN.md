---
phase: 06-silk-encoder
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/silk/pitch_detect.go
  - internal/silk/encode_frame.go
  - internal/silk/ltp_encode.go
  - internal/silk/roundtrip_test.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Encoder output decodes without panic"
    - "Pitch lag values reconstruct correctly"
    - "LTP coefficients decode to valid codebook entries"
    - "Mono round-trip test passes"
  artifacts:
    - path: "internal/silk/pitch_detect.go"
      provides: "Fixed pitch lag encoding matching decoder format"
      contains: "ICDFPitchLowBitsQ2"
    - path: "internal/silk/roundtrip_test.go"
      provides: "Actual encoder-decoder round-trip tests"
      exports: ["TestMonoRoundTrip"]
  key_links:
    - from: "pitch_detect.go:encodePitchLags"
      to: "pitch.go:decodePitchLag"
      via: "Matching ICDF tables and divisor"
      pattern: "ICDFPitchLowBitsQ2.*divisor.*4"
---

<objective>
Fix encoder-decoder bitstream incompatibility for pitch lag encoding and add round-trip tests.

Purpose: The SILK encoder produces output that crashes the decoder with "index out of range [4] with length 4" at pitch.go:53. This is caused by mismatched pitch lag encoding format between encoder and decoder.

Output: Working encoder-decoder round-trip for mono SILK frames.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/silk/pitch.go
@internal/silk/pitch_detect.go
@internal/silk/encode_frame.go
@internal/silk/tables.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix pitch lag encoding to match decoder format</name>
  <files>internal/silk/pitch_detect.go</files>
  <action>
Fix the `encodePitchLags` function to use the correct ICDF tables matching the decoder:

**Root cause:** The encoder uses wrong divisor and ICDF tables for pitch lag encoding:
- Encoder uses ICDFPitchLowBitsQ4 (16 values) with divisor=16 for WB
- Decoder uses ICDFPitchLowBitsQ2 (4 values) with divisor=4 for ALL bandwidths

**Per RFC 6716 Section 4.2.7.6.1:**
- Pitch lag = PitchLagMin + lagHigh * 4 + lagLow
- lagLow is ALWAYS 2 bits (4 values), regardless of bandwidth
- The high bits table varies by bandwidth, but low bits are always Q2

**Changes required in encodePitchLags (lines 233-274):**

1. Change divisor to 4 for ALL bandwidths (currently incorrectly uses 4/8/16)
2. Change lagLowICDF to ICDFPitchLowBitsQ2 for ALL bandwidths (currently uses Q2/Q3/Q4)
3. Keep lagHighICDF bandwidth-specific (this is correct)

Before (incorrect):
```go
switch e.bandwidth {
case BandwidthNarrowband:
    lagHighICDF = ICDFPitchLagNB
    lagLowICDF = ICDFPitchLowBitsQ2
    divisor = 4
case BandwidthMediumband:
    lagHighICDF = ICDFPitchLagMB
    lagLowICDF = ICDFPitchLowBitsQ3  // WRONG
    divisor = 8                       // WRONG
default: // Wideband
    lagHighICDF = ICDFPitchLagWB
    lagLowICDF = ICDFPitchLowBitsQ4  // WRONG
    divisor = 16                      // WRONG
}
```

After (correct):
```go
switch e.bandwidth {
case BandwidthNarrowband:
    lagHighICDF = ICDFPitchLagNB
case BandwidthMediumband:
    lagHighICDF = ICDFPitchLagMB
default: // Wideband
    lagHighICDF = ICDFPitchLagWB
}
// Low bits are ALWAYS 2 bits (Q2) per RFC 6716
lagLowICDF = ICDFPitchLowBitsQ2
divisor = 4
```

Also verify maxHighIdx clamping matches the ICDF table size.
  </action>
  <verify>Run `go build ./internal/silk/...` - should compile without errors</verify>
  <done>encodePitchLags uses ICDFPitchLowBitsQ2 and divisor=4 for all bandwidths</done>
</task>

<task type="auto">
  <name>Task 2: Fix LTP coefficient encoding order</name>
  <files>internal/silk/ltp_encode.go</files>
  <action>
Verify LTP coefficient encoding matches decoder order. The decoder at pitch.go:85-137 decodes:
1. Periodicity index via multi-stage ICDF (Low -> Mid -> High)
2. LTP filter index per subframe

Check `encodeLTPCoeffs` in ltp_encode.go:
- Verify periodicity encoding uses same multi-stage logic
- Verify filter index encoding uses correct ICDF per periodicity level

The decoder logic (pitch.go:89-99) is:
```go
periodicityIdx := d.rangeDecoder.DecodeICDF16(ICDFLTPFilterIndexLowPeriod, 8)
if periodicityIdx < 4 {
    periodicity = 0
} else {
    periodicityIdx = d.rangeDecoder.DecodeICDF16(ICDFLTPFilterIndexMidPeriod, 8)
    if periodicityIdx < 5 {
        periodicity = 1
    } else {
        periodicity = 2
    }
}
```

The encoder must:
1. For periodicity 0: encode index 0-3 via ICDFLTPFilterIndexLowPeriod
2. For periodicity 1: encode index >= 4 via ICDFLTPFilterIndexLowPeriod, then 0-4 via ICDFLTPFilterIndexMidPeriod
3. For periodicity 2: encode index >= 4 via ICDFLTPFilterIndexLowPeriod, then >= 5 via ICDFLTPFilterIndexMidPeriod

If the encoder logic differs, fix it to match the decoder.
  </action>
  <verify>Run `go build ./internal/silk/...` - should compile without errors</verify>
  <done>LTP coefficient encoding matches decoder's multi-stage periodicity decoding</done>
</task>

<task type="auto">
  <name>Task 3: Add actual round-trip tests</name>
  <files>internal/silk/roundtrip_test.go</files>
  <action>
Create new test file with actual encoder-decoder round-trip tests that DECODE the encoded output.

Tests to implement:

1. `TestMonoRoundTrip_Unvoiced`: Encode noise signal (unvoiced), decode, verify no panic
2. `TestMonoRoundTrip_Voiced`: Encode periodic signal (voiced), decode, verify no panic
3. `TestMonoRoundTrip_AllBandwidths`: Test NB, MB, WB bandwidths
4. `TestMonoRoundTrip_SignalRecovery`: Verify decoded signal correlates with original

Test structure for each:
```go
func TestMonoRoundTrip_Voiced(t *testing.T) {
    config := GetBandwidthConfig(BandwidthWideband)
    frameSamples := config.SampleRate * 20 / 1000

    // Generate voiced signal (300 Hz sine)
    pcm := make([]float32, frameSamples)
    for i := range pcm {
        pcm[i] = float32(math.Sin(2*math.Pi*300*float64(i)/float64(config.SampleRate))) * 10000
    }

    // Encode
    encoded, err := Encode(pcm, BandwidthWideband, true)
    if err != nil {
        t.Fatalf("Encode failed: %v", err)
    }

    // Decode using Phase 2 decoder
    decoder := NewDecoder()
    rd := rangecoding.NewDecoder(encoded)
    decoded, err := decoder.DecodeFrame(rd, BandwidthWideband, Frame20ms, true)
    if err != nil {
        t.Fatalf("Decode failed: %v", err)
    }

    // Verify basic properties
    if len(decoded) != frameSamples {
        t.Errorf("Decoded length %d != expected %d", len(decoded), frameSamples)
    }

    t.Logf("Round-trip: %d samples -> %d bytes -> %d samples",
        len(pcm), len(encoded), len(decoded))
}
```

Import requirements:
- "gopus/internal/rangecoding"
- "math"
- "testing"

The tests MUST actually call decoder.DecodeFrame on encoded output. This is the critical gap - existing tests only verify encoding produces bytes.
  </action>
  <verify>Run `go test -v ./internal/silk/... -run TestMonoRoundTrip` - all tests should pass without panic</verify>
  <done>Round-trip tests exist and pass, proving encoder output is decodable by Phase 2 decoder</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `go test -v ./internal/silk/... -run TestMonoRoundTrip` passes
2. No panics during decode of encoded output
3. Decoded sample count matches expected frame length
4. All three bandwidths (NB, MB, WB) work
</verification>

<success_criteria>
- [ ] Pitch lag encoding uses ICDFPitchLowBitsQ2 with divisor=4 for all bandwidths
- [ ] LTP encoding matches decoder's multi-stage periodicity logic
- [ ] TestMonoRoundTrip_Voiced passes (no panic, correct length)
- [ ] TestMonoRoundTrip_Unvoiced passes (no panic, correct length)
- [ ] TestMonoRoundTrip_AllBandwidths passes (NB, MB, WB)
- [ ] Encoded output actually decodes via Phase 2 decoder without error
</success_criteria>

<output>
After completion, create `.planning/phases/06-silk-encoder/06-06-SUMMARY.md`
</output>
