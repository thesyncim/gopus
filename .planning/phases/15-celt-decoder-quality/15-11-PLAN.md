---
phase: 15-celt-decoder-quality
plan: 11
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/celt/libopus_comparison_test.go
  - internal/testvectors/bitstream_comparison_test.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Exact divergence point between gopus and libopus identified for CELT test vectors"
    - "First frame of first packet compared stage-by-stage with reference"
  artifacts:
    - path: "internal/testvectors/bitstream_comparison_test.go"
      provides: "Stage-by-stage decode comparison with reference"
      min_lines: 100
    - path: "internal/celt/libopus_comparison_test.go"
      provides: "Decode value extraction and comparison utilities"
      min_lines: 50
  key_links:
    - from: "bitstream_comparison_test.go"
      to: "celt.DefaultTracer"
      via: "trace capture"
      pattern: "SetTracer"
---

<objective>
Identify exact divergence point between gopus CELT decoder and reference output

Purpose: All component-level tests pass, but Q=-100. The problem is in how components connect, not individual components. This plan uses bitstream-level analysis to find where gopus diverges from expected behavior.

Approach:
1. Decode first CELT packet with comprehensive tracing
2. Compare intermediate values at each stage with expected behavior
3. Identify first stage where output diverges significantly

Output: Diagnosis document with exact stage and nature of divergence
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-celt-decoder-quality/15-09-SUMMARY.md
@.planning/phases/15-celt-decoder-quality/15-VERIFICATION-v2.md

# Key files - CELT decoder internals
@internal/celt/decoder.go
@internal/celt/energy.go
@internal/celt/bands.go
@internal/celt/synthesis.go
@internal/celt/debug_trace.go
@internal/testvectors/compliance_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive first-packet trace test</name>
  <files>internal/testvectors/bitstream_comparison_test.go</files>
  <action>
  Create test that decodes ONLY the first frame of testvector01 (CELT stereo) with full tracing:

  1. Parse testvector01.bit, extract first packet
  2. Set up comprehensive tracer that captures ALL intermediate values:
     - Header flags (silence, transient, intra, LM)
     - Range decoder state after each decode operation (tell(), val, rng)
     - Coarse energy for each band (21 bands x 2 channels)
     - Fine energy adjustments
     - Bit allocation per band
     - PVQ decode: band, n, k, index, pulses
     - Denormalized coefficients (first 8 per band)
     - Synthesis output (first 32 samples)

  3. Output structured comparison data:
     ```
     === First Packet Analysis ===
     Packet: 123 bytes, TOC: 0xBC (config=23, stereo=true)

     === Range Decoder State ===
     After header: tell=5, val=0xABCD, rng=0x1234
     After coarse[0]: tell=12, val=0xEFGH, rng=0x5678
     ...

     === Coarse Energy (ch=0) ===
     Band 0: qi=2, pred=1.5, total=13.5
     Band 1: qi=-1, pred=12.0, total=6.0
     ...

     === PVQ Decode ===
     Band 0: n=8, k=3, index=42, pulses=[1,-1,0,1,0,0,0,0]
     ...
     ```

  Test name: TestCELTFirstPacketAnalysis
  </action>
  <verify>go test -v ./internal/testvectors -run TestCELTFirstPacketAnalysis -count=1</verify>
  <done>Test outputs comprehensive decode trace for first CELT packet</done>
</task>

<task type="auto">
  <name>Task 2: Compare decoded output with reference byte-by-byte</name>
  <files>internal/testvectors/bitstream_comparison_test.go</files>
  <action>
  Add test that compares gopus output with reference for first packet:

  1. Decode first packet from testvector01
  2. Read corresponding samples from testvector01.dec (first frameSize*channels samples)
  3. Compare sample-by-sample:
     - Output: decoded[i], reference[i], diff, cumulative_error
     - Find first sample where |diff| > threshold (e.g., 1000)
     - Calculate error metrics: max_diff, mean_diff, first_divergence_sample

  4. Analyze divergence pattern:
     - If divergence at sample 0: header/energy decode wrong
     - If divergence after N samples: synthesis issue in that region
     - If systematic offset: energy scale wrong
     - If random: bitstream desync

  Output format:
  ```
  === First Packet Comparison ===
  Decoded: 960 samples, Reference: 960 samples

  First 10 samples:
    Sample 0: decoded=1234, ref=1234, diff=0
    Sample 1: decoded=1567, ref=-8901, diff=10468 <-- FIRST DIVERGENCE
    ...

  Error metrics:
    Max diff: 32767
    Mean abs diff: 15234
    First divergence: sample 1 (0.02ms into frame)

  Pattern analysis:
    Decoded energy: 1.2e6
    Reference energy: 4.5e8
    Energy ratio: 0.003 (0.3%)
  ```

  Test name: TestCELTFirstPacketComparison
  </action>
  <verify>go test -v ./internal/testvectors -run TestCELTFirstPacketComparison -count=1</verify>
  <done>Test outputs comparison showing exact divergence point and pattern</done>
</task>

<task type="auto">
  <name>Task 3: Create divergence diagnosis summary</name>
  <files>internal/celt/libopus_comparison_test.go</files>
  <action>
  Based on Tasks 1-2 output, create test that generates diagnosis:

  1. Run first-packet trace and comparison
  2. Analyze patterns to identify likely cause:
     - Energy values reasonable? (typically -10 to +20 dB)
     - PVQ pulses reasonable? (sum = k)
     - Coefficients have expected magnitude? (based on energy)
     - IMDCT output has expected scale?

  3. Generate hypothesis about root cause based on observations:
     - "Energy too high by factor X" -> denormalization bug
     - "Energy too low by factor X" -> energy decode bug
     - "Signs flipped" -> sign handling bug
     - "Values look random" -> bitstream desync
     - "Off by N samples" -> overlap-add bug
     - "Correct shape, wrong scale" -> gain calculation bug

  4. Output diagnosis document:
     ```
     === Divergence Diagnosis ===

     Observation: [specific finding]
     Hypothesis: [likely cause]
     Evidence: [data supporting hypothesis]

     Recommended investigation:
     1. Check [specific code path]
     2. Compare [specific values] with expected
     ```

  Test name: TestCELTDivergenceDiagnosis
  </action>
  <verify>go test -v ./internal/celt -run TestCELTDivergenceDiagnosis -count=1</verify>
  <done>Test outputs diagnosis with specific hypothesis about root cause</done>
</task>

</tasks>

<verification>
1. TestCELTFirstPacketAnalysis produces comprehensive trace output
2. TestCELTFirstPacketComparison shows exact divergence point
3. TestCELTDivergenceDiagnosis provides actionable hypothesis
4. All tests run without panics
</verification>

<success_criteria>
- [ ] First-packet trace captures all intermediate decode values
- [ ] Divergence point identified (specific sample number)
- [ ] Divergence pattern characterized (scale, sign, random, etc.)
- [ ] Hypothesis generated about root cause
- [ ] Evidence documented for next investigation step
</success_criteria>

<output>
After completion, create `.planning/phases/15-celt-decoder-quality/15-11-SUMMARY.md`

The summary should include:
- Specific divergence finding (e.g., "output diverges at sample 0")
- Pattern observed (e.g., "values are ~1000x too small")
- Hypothesis (e.g., "energy denormalization using wrong scale")
- Next step recommendation
</output>
