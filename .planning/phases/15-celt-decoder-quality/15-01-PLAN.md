---
phase: 15-celt-decoder-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/celt/tables.go
  - internal/celt/energy.go
  - internal/celt/tables_test.go
autonomous: true

must_haves:
  truths:
    - "BetaCoef uses correct LM-dependent values from libopus"
    - "BetaCoef intra mode uses 0.15, not 0.85"
    - "Coarse energy prediction update formula matches libopus"
  artifacts:
    - path: "internal/celt/tables.go"
      provides: "Corrected BetaCoef array"
      contains: "BetaCoefInter"
    - path: "internal/celt/energy.go"
      provides: "Fixed energy prediction"
      contains: "BetaIntra"
    - path: "internal/celt/tables_test.go"
      provides: "Coefficient validation tests"
      contains: "TestBetaCoef"
  key_links:
    - from: "internal/celt/energy.go"
      to: "internal/celt/tables.go"
      via: "BetaCoefInter lookup"
      pattern: "BetaCoefInter\\[lm\\]"
---

<objective>
Fix coarse energy prediction coefficients to match libopus exactly

Purpose: The BetaCoef array uses a fixed incorrect value (0.85) for all LM values. libopus uses LM-dependent beta coefficients for inter-frame mode (0.92, 0.68, 0.37, 0.20) and a fixed 0.15 for intra mode. This is the highest-priority fix identified in research - wrong energy prediction cascades through the entire decoding pipeline causing Q=-100.

Output: Corrected prediction coefficient tables and energy decoding logic that matches libopus quant_bands.c exactly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-celt-decoder-quality/15-RESEARCH.md
@internal/celt/tables.go
@internal/celt/energy.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix BetaCoef table in tables.go</name>
  <files>internal/celt/tables.go</files>
  <action>
Replace the incorrect BetaCoef array with corrected values from libopus:

1. Rename current BetaCoef to BetaCoefInter (inter-frame mode, LM-dependent):
```go
// BetaCoefInter contains inter-band energy prediction coefficients for INTER-frame mode.
// Values vary by LM (log mode / frame size). Source: libopus celt/quant_bands.c
var BetaCoefInter = [4]float64{
    30147.0 / 32768.0, // LM=0 (2.5ms): 0.9200744...
    22282.0 / 32768.0, // LM=1 (5ms):   0.6800537...
    12124.0 / 32768.0, // LM=2 (10ms):  0.3700561...
    6554.0 / 32768.0,  // LM=3 (20ms):  0.2000122...
}
```

2. Add BetaIntra constant for intra-frame mode:
```go
// BetaIntra is the inter-band prediction coefficient for INTRA-frame mode.
// No inter-frame prediction, only inter-band. Source: libopus celt/quant_bands.c
const BetaIntra = 4915.0 / 32768.0 // 0.15
```

3. Keep AlphaCoef unchanged (already correct).

4. Remove or deprecate the old incorrect BetaCoef (do NOT keep both - remove old one to avoid confusion).
  </action>
  <verify>go build ./internal/celt/... compiles without error</verify>
  <done>BetaCoefInter array has 4 distinct LM-dependent values, BetaIntra constant equals 0.15</done>
</task>

<task type="auto">
  <name>Task 2: Update DecodeCoarseEnergy to use corrected coefficients</name>
  <files>internal/celt/energy.go</files>
  <action>
Modify DecodeCoarseEnergy() to use the corrected prediction coefficients:

1. In the intra branch, use BetaIntra (0.15) instead of BetaCoef[lm]:
```go
if intra {
    alpha = 0.0
    beta = BetaIntra  // Fixed 0.15 for intra mode
} else {
    alpha = AlphaCoef[lm]
    beta = BetaCoefInter[lm]  // LM-dependent for inter mode
}
```

2. Fix the inter-band prediction update formula. Current code:
```go
prevBandEnergy = energy
```
Should be (per libopus):
```go
prevBandEnergy = prevBandEnergy + float64(qi)*DB6 - beta*float64(qi)*DB6
```
This is equivalent to: `prev = prev + q - beta*q` where q = qi*DB6

The key insight: prevBandEnergy accumulates a filtered version of the quantized deltas, NOT the final energy values.

3. Verify the prediction formula:
```go
pred := alpha*prevFrameEnergy + beta*prevBandEnergy
```
This part is correct - do NOT change.
  </action>
  <verify>go build ./internal/celt/... compiles; go test ./internal/celt/... -run TestDecodeCoarseEnergy passes</verify>
  <done>DecodeCoarseEnergy uses BetaIntra for intra mode, BetaCoefInter[lm] for inter mode, and inter-band predictor update matches libopus formula</done>
</task>

<task type="auto">
  <name>Task 3: Add coefficient validation tests</name>
  <files>internal/celt/tables_test.go</files>
  <action>
Create or update tables_test.go with tests validating the corrected coefficients:

```go
package celt

import (
    "math"
    "testing"
)

func TestAlphaCoef(t *testing.T) {
    // Values from libopus celt/quant_bands.c
    expected := []float64{
        29440.0 / 32768.0, // LM=0: 0.8984375
        26112.0 / 32768.0, // LM=1: 0.796875
        21248.0 / 32768.0, // LM=2: 0.6484375
        16384.0 / 32768.0, // LM=3: 0.5
    }

    for lm := 0; lm < 4; lm++ {
        if math.Abs(AlphaCoef[lm] - expected[lm]) > 1e-10 {
            t.Errorf("AlphaCoef[%d] = %v, want %v", lm, AlphaCoef[lm], expected[lm])
        }
    }
}

func TestBetaCoefInter(t *testing.T) {
    // Values from libopus celt/quant_bands.c for INTER mode
    expected := []float64{
        30147.0 / 32768.0, // LM=0: 0.9200744...
        22282.0 / 32768.0, // LM=1: 0.6800537...
        12124.0 / 32768.0, // LM=2: 0.3700561...
        6554.0 / 32768.0,  // LM=3: 0.2000122...
    }

    for lm := 0; lm < 4; lm++ {
        if math.Abs(BetaCoefInter[lm] - expected[lm]) > 1e-10 {
            t.Errorf("BetaCoefInter[%d] = %v, want %v", lm, BetaCoefInter[lm], expected[lm])
        }
    }

    // Verify values are distinct (not all 0.85 like old bug)
    for i := 0; i < 3; i++ {
        if BetaCoefInter[i] == BetaCoefInter[i+1] {
            t.Errorf("BetaCoefInter[%d] == BetaCoefInter[%d], values should be distinct", i, i+1)
        }
    }
}

func TestBetaIntra(t *testing.T) {
    expected := 4915.0 / 32768.0 // 0.15
    if math.Abs(BetaIntra - expected) > 1e-10 {
        t.Errorf("BetaIntra = %v, want %v", BetaIntra, expected)
    }
}
```
  </action>
  <verify>go test ./internal/celt/... -run "TestAlphaCoef|TestBetaCoef|TestBetaIntra" -v passes</verify>
  <done>All coefficient tests pass, confirming values match libopus exactly</done>
</task>

</tasks>

<verification>
- `go build ./...` compiles successfully
- `go test ./internal/celt/... -v` passes all tests
- BetaCoefInter[0] = 0.920... (not 0.85)
- BetaCoefInter[3] = 0.200... (not 0.85)
- BetaIntra = 0.15 (not 0.85)
</verification>

<success_criteria>
- Prediction coefficient values match libopus celt/quant_bands.c exactly
- Energy prediction uses correct beta based on intra/inter mode and LM
- All existing CELT tests continue to pass
- New coefficient validation tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/15-celt-decoder-quality/15-01-SUMMARY.md`
</output>
