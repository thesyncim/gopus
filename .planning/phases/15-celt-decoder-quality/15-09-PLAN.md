---
phase: 15-celt-decoder-quality
plan: 09
type: execute
wave: 3
depends_on: ["15-07", "15-08"]
files_modified:
  - internal/celt/decoder.go
  - internal/celt/bands.go
  - internal/celt/energy.go
  - internal/celt/alloc.go
autonomous: false
gap_closure: true
checkpoint_dependent_scope: true  # Scope varies based on checkpoint decision; files_modified is maximum potential set

must_haves:
  truths:
    - "Root cause of Q=-100 is identified from prior plan diagnostics"
    - "Identified bug is fixed based on diagnostic evidence"
    - "At least one CELT test vector shows quality improvement"
  artifacts:
    - path: "internal/celt/decoder.go"
      provides: "Fixed CELT decoder"
      min_lines: 500
  key_links:
    - from: "internal/celt/decoder.go"
      to: "internal/rangecoding/decoder.go"
      via: "Range decoder integration"
      pattern: "rd\\.Decode"
---

<objective>
Fix the root cause of Q=-100 based on diagnostic evidence from plans 15-06, 15-07, 15-08

Purpose: Plans 15-06/07/08 provide diagnostic infrastructure (tracing, PVQ tests, allocation tests, bit consumption tracking). This plan uses that diagnostic data to identify and fix the actual bug causing complete output mismatch. The plan can proceed once EITHER 15-07 OR 15-08 completes (both provide independent diagnostic data), though having both provides more comprehensive evidence.

Dependency clarification: This plan depends on both 15-07 and 15-08 in the sense that they must be complete before execution, but the diagnostic evidence from either plan alone may be sufficient to identify the root cause. The checkpoint decision (Task 1) will determine which diagnostic data is most actionable.

Output: Fixed CELT decoder with improved quality on at least one test vector
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-celt-decoder-quality/15-VERIFICATION.md
@.planning/phases/15-celt-decoder-quality/15-06-SUMMARY.md (if exists)
@.planning/phases/15-celt-decoder-quality/15-07-SUMMARY.md (if exists)
@.planning/phases/15-celt-decoder-quality/15-08-SUMMARY.md (if exists)

Key files (likely to need fixes based on common CELT decoder bugs):
@internal/celt/decoder.go
@internal/celt/bands.go
@internal/celt/energy.go
@internal/celt/alloc.go
@internal/celt/cwrs.go
@internal/celt/pvq.go
</context>

<tasks>

<task type="checkpoint:decision" gate="blocking">
  <decision>Identify root cause from diagnostic evidence</decision>
  <context>
Plans 15-06/07/08 should have produced diagnostic output showing:
- Trace of CELT decoding stages with intermediate values
- PVQ/CWRS test results (pass/fail)
- Bit allocation test results (pass/fail)
- Bit consumption tracking (expected vs actual)

Common CELT decoder bugs and their signatures:
1. **CWRS indexing bug**: PVQ tests fail, pulse vectors incorrect
2. **Bit allocation mismatch**: Bit consumption doesn't match allocation, later bands get garbage
3. **Energy prediction bug**: Energy values are reasonable but wrong (already fixed in 15-01/02?)
4. **Range decoder desync**: Total bits consumed != packet bits, values diverge mid-packet
5. **Coefficient assembly bug**: Individual bands decode correctly, but assembly is wrong
6. **Stereo processing bug**: Mono works, stereo doesn't (or vice versa)
7. **Frame size scaling bug**: Some frame sizes work, others don't
  </context>
  <options>
    <option id="cwrs-fix">
      <name>CWRS indexing fix</name>
      <pros>Would fix all band decoding</pros>
      <cons>May not be the issue if tests pass</cons>
    </option>
    <option id="alloc-fix">
      <name>Bit allocation fix</name>
      <pros>Would fix range decoder sync</pros>
      <cons>Complex algorithm</cons>
    </option>
    <option id="energy-fix">
      <name>Energy decoding additional fix</name>
      <pros>Simple fix if identified</pros>
      <cons>May already be correct</cons>
    </option>
    <option id="assembly-fix">
      <name>Coefficient assembly fix</name>
      <pros>Would fix final output</pros>
      <cons>Harder to verify</cons>
    </option>
    <option id="multiple-fix">
      <name>Multiple issues to fix</name>
      <pros>Addresses all found issues</pros>
      <cons>More complex</cons>
    </option>
    <option id="inconclusive">
      <name>Diagnostics inconclusive</name>
      <pros>Avoids fixing wrong thing</pros>
      <cons>Requires additional investigation</cons>
      <next-steps>
        If diagnostic evidence from 15-06/07/08 does not clearly identify the root cause:
        1. Review trace output for patterns not matching any known bug signature
        2. Consider adding more targeted traces (e.g., specific to identified anomaly)
        3. May need to compare byte-by-byte with libopus reference decoder
        4. Could require creating a minimal repro case for deeper analysis
        5. Report findings and request user guidance on investigation direction
      </next-steps>
    </option>
  </options>
  <resume-signal>
Review diagnostic output from 15-06/07/08 and identify which option applies.
Report which tests failed, what the trace showed, and select the appropriate fix path.
If diagnostics are inconclusive, select "inconclusive" and describe what additional investigation is needed.
  </resume-signal>
</task>

<task type="auto">
  <name>Task 2: Apply targeted fix based on root cause</name>
  <files>internal/celt/decoder.go, internal/celt/bands.go, internal/celt/energy.go, internal/celt/alloc.go, internal/celt/cwrs.go</files>
  <action>
Based on the root cause identified in Task 1, apply the targeted fix.

**If CWRS indexing bug:**
- Review DecodePulses algorithm
- Compare with libopus celt/cwrs.c cwrs64_decode_pulses()
- Fix index interpretation, sign bit extraction, or recurrence formula

**If bit allocation bug:**
- Compare ComputeAllocation with libopus celt/rate.c
- Fix budget calculation, scaling, or distribution
- Ensure sum(BandBits) + sum(FineBits) == expected

**If energy decoding bug:**
- Check coarse energy prediction formula
- Check fine energy uniform decode
- Check energy remainder handling

**If coefficient assembly bug:**
- Check band coefficient ordering
- Check scaling by energy
- Check transient mode interleaving

**If range decoder desync:**
- Add bit position assertions after each stage
- Find where actual diverges from expected
- Fix the stage that consumes wrong bits

**If inconclusive:**
- Add more targeted diagnostic traces based on observed anomalies
- Create minimal test case isolating the suspicious behavior
- Document findings for further investigation

Document the fix with clear comments explaining:
- What was wrong
- How it was identified
- How it was fixed
- Reference to libopus equivalent code
  </action>
  <verify>go test ./internal/celt/... -count=1 passes</verify>
  <done>Fix applied based on diagnostic evidence, tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Verify quality improvement on test vectors</name>
  <files>internal/testvectors/compliance_test.go</files>
  <action>
Run CELT test vectors and verify quality improvement.

1. Run TestDecoderCompliance focused on CELT vectors:
   ```
   go test -v ./internal/testvectors/... -run "TestDecoderCompliance/testvector01" -count=1
   go test -v ./internal/testvectors/... -run "TestDecoderCompliance/testvector07" -count=1
   go test -v ./internal/testvectors/... -run "TestDecoderCompliance/testvector11" -count=1
   ```

2. Record Q values before and after fix:
   - Before: Q=-100 (from verification)
   - After: Q=??? (should be better)

3. If Q is still very negative but improved:
   - Identify remaining issues
   - May need additional fixes in subsequent plan

4. If Q >= 0 on any vector:
   - Document as success
   - Phase goal partially achieved

5. Update any tests that now need adjustment due to the fix.
  </action>
  <verify>At least one CELT test vector shows Q > -100 (improved quality)</verify>
  <done>Quality measured on CELT test vectors, improvement documented</done>
</task>

</tasks>

<verification>
- All CELT tests pass
- At least one CELT test vector shows quality improvement (Q > -100)
- Fix is documented with comments explaining the issue
- No regressions in other tests
</verification>

<success_criteria>
- Root cause identified from diagnostic evidence
- Targeted fix applied and tested
- Quality improvement verified on at least one CELT test vector
- If Q >= 0 achieved on any vector, DEQ-02 progress made
</success_criteria>

<output>
After completion, create `.planning/phases/15-celt-decoder-quality/15-09-SUMMARY.md`
</output>
