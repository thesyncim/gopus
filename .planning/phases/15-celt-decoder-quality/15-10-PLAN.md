---
phase: 15-celt-decoder-quality
plan: 10
type: execute
wave: 1
depends_on: []
files_modified:
  - decoder.go
  - internal/testvectors/compliance_test.go
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Mono CELT test vector (testvector07) produces correct sample count matching reference"
    - "Mono and stereo CELT packets decoded with consistent handling"
  artifacts:
    - path: "decoder.go"
      provides: "Mono CELT sample count handling"
      contains: "mono handling"
    - path: "internal/testvectors/compliance_test.go"
      provides: "Mono sample count verification"
      contains: "mono sample count"
  key_links:
    - from: "decoder.go"
      to: "getTotalSamples"
      via: "mono channel count calculation"
      pattern: "channels.*mono"
---

<objective>
Fix mono CELT sample count discrepancy in testvector07

Purpose: testvector07 (mono CELT) produces 1085040 samples vs 2170080 reference - exactly 2x difference. This suggests either:
1. Reference file is stereo output for mono source (libopus convention)
2. Decoder needs to duplicate mono to stereo for output matching
3. Sample counting has a mono-specific bug

Output: Mono CELT decoding produces correct sample count matching reference files
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-celt-decoder-quality/15-09-SUMMARY.md
@.planning/phases/15-celt-decoder-quality/15-VERIFICATION-v2.md

# Key files
@decoder.go
@internal/testvectors/compliance_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Investigate mono reference file format</name>
  <files>internal/testvectors/compliance_test.go</files>
  <action>
  Add a test that inspects testvector07 reference file (.dec) to determine its format:

  1. Read testvector07.dec and count samples
  2. Parse testvector07.bit to get packet info (check TOC stereo bit)
  3. Calculate expected samples: sum of (frameSize * frameCount) per packet
  4. Compare:
     - If reference samples = 2 * decoded samples: reference is stereo output for mono source
     - If reference samples = decoded samples: mono handling bug in decoder

  Key checks:
  - TOC byte bit 2 (stereo flag): should be 0 for mono
  - First few reference samples: check if L/R are identical (stereo from mono) or independent

  Create test: TestMonoCELTReferenceFormat that outputs diagnostic info.
  </action>
  <verify>go test -v ./internal/testvectors -run TestMonoCELTReferenceFormat -count=1</verify>
  <done>Test runs and outputs: (1) reference sample count, (2) expected decoded sample count, (3) whether reference appears to be stereo-from-mono</done>
</task>

<task type="auto">
  <name>Task 2: Fix mono-to-stereo output conversion if needed</name>
  <files>decoder.go</files>
  <action>
  Based on Task 1 findings, if reference files contain stereo output for mono sources:

  1. Add mono-to-stereo conversion in Decode/DecodeInt16 for compliance testing
  2. Option A (likely): If reference is stereo (2 channels), but packet is mono, duplicate samples:
     - Output L0, L0, L1, L1, ... instead of L0, L1, ...
     - This matches libopus opus_demo behavior which outputs stereo regardless of input channels

  3. Option B: If mono handling has actual bug, fix the sample counting logic

  Implementation approach:
  - After decoding, check if output channels != reference expected channels
  - If mono->stereo conversion needed, duplicate samples
  - Add helper function `duplicateMonoToStereo(samples []int16) []int16`

  Important: Only apply for compliance testing - keep normal API behavior unchanged.
  Consider adding a flag or using the sampleRate/channels mismatch detection.
  </action>
  <verify>go test -v ./internal/testvectors -run TestSingleVector/testvector07 -count=1</verify>
  <done>testvector07 sample count matches reference (2170080 = 2170080)</done>
</task>

<task type="auto">
  <name>Task 3: Verify all mono vectors pass sample count check</name>
  <files>internal/testvectors/compliance_test.go</files>
  <action>
  Update compliance test to report sample count matching for all vectors:

  1. Add sample count verification to runVectorSilent/runTestVector
  2. Log: "Sample count: decoded=%d, reference=%d, match=%v"
  3. Verify testvector07 now has matching sample counts

  Check that fix doesn't break stereo vectors (01, 11) which already match.
  </action>
  <verify>go test -v ./internal/testvectors -run TestComplianceSummary -count=1 2>&1 | grep -E "(testvector|Sample count)"</verify>
  <done>All CELT vectors (01, 07, 11) show matching sample counts in summary</done>
</task>

</tasks>

<verification>
1. TestMonoCELTReferenceFormat passes and outputs diagnostic info
2. testvector07 shows matching sample count (was: 1085040 vs 2170080)
3. testvector01 and testvector11 (stereo) still have matching sample counts
4. No regressions in other test vectors
</verification>

<success_criteria>
- [ ] Mono CELT sample count discrepancy diagnosed
- [ ] Fix applied if needed (mono-to-stereo conversion or bug fix)
- [ ] testvector07 sample count matches reference
- [ ] Stereo vectors unchanged (01, 11 still match)
</success_criteria>

<output>
After completion, create `.planning/phases/15-celt-decoder-quality/15-10-SUMMARY.md`
</output>
