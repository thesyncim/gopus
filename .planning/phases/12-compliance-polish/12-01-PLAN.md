---
phase: 12-compliance-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/encoder/encoder_test.go
  - internal/encoder/integration_test.go
  - internal/encoder/libopus_test.go
  - internal/encoder/fec_test.go
autonomous: true

must_haves:
  truths:
    - "`go test ./...` passes without import cycle errors"
    - "All existing encoder tests continue to pass"
    - "Encoder tests can import both gopus and internal/encoder without conflict"
  artifacts:
    - path: "internal/encoder/encoder_test.go"
      provides: "Import-cycle-free encoder unit tests"
      contains: "package encoder_test"
    - path: "internal/encoder/integration_test.go"
      provides: "Import-cycle-free integration tests"
      contains: "package encoder_test"
  key_links:
    - from: "internal/encoder/*_test.go"
      to: "gopus"
      via: "external test package (encoder_test)"
      pattern: "package encoder_test"
---

<objective>
Fix the import cycle in internal/encoder tests so `go test ./...` passes

Purpose: The internal/encoder test files currently import both the gopus public package and internal/encoder, creating an import cycle that causes batch test mode to fail. This blocks CI and makes full test runs impossible.

Output: Test files refactored to use external test package pattern (package encoder_test), eliminating the import cycle while preserving all test coverage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/encoder/encoder_test.go
@internal/encoder/integration_test.go
@internal/encoder/libopus_test.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor encoder_test.go to external test package</name>
  <files>internal/encoder/encoder_test.go</files>
  <action>
Convert internal/encoder/encoder_test.go from `package encoder` to `package encoder_test`.

Changes required:
1. Change package declaration to `package encoder_test`
2. Add import `"gopus/internal/encoder"`
3. Prefix all internal type references with `encoder.` (e.g., `encoder.NewEncoder`, `encoder.ModeAuto`, `encoder.ModeSILK`)
4. For any test that needs access to unexported types/functions, either:
   - Add export wrappers in a new file `internal/encoder/export_test.go` with `package encoder`
   - Or restructure the test to use only exported API

Key types to prefix:
- NewEncoder -> encoder.NewEncoder
- ModeAuto, ModeSILK, ModeCELT, ModeHybrid -> encoder.ModeAuto, etc.
- Encoder methods remain unchanged (called on instances)

The gopus import can remain as-is since it's now from a separate test package.

Verify tests still test the same functionality by comparing test names and assertions before/after.
  </action>
  <verify>
`go test -v ./internal/encoder/... -run TestNewEncoder` passes
`go test -c ./internal/encoder` compiles without import cycle error
  </verify>
  <done>encoder_test.go uses external test package pattern and compiles without import cycle</done>
</task>

<task type="auto">
  <name>Task 2: Refactor remaining test files to external test package</name>
  <files>internal/encoder/integration_test.go, internal/encoder/libopus_test.go, internal/encoder/packet_test.go</files>
  <action>
Apply the same external test package pattern to all remaining test files in internal/encoder:

1. internal/encoder/integration_test.go:
   - Change to `package encoder_test`
   - Add encoder import prefix to type references
   - Keep gopus import as-is

2. internal/encoder/libopus_test.go:
   - Change to `package encoder_test`
   - Add encoder import prefix to type references
   - Keep all test logic unchanged

3. internal/encoder/packet_test.go:
   - Change to `package encoder_test`
   - Add encoder import prefix

If any test file accesses unexported functions or types, add them to export_test.go:
```go
// internal/encoder/export_test.go
package encoder

// Export unexported items for testing
var ExportedUnexportedFunc = unexportedFunc
```

Ensure ALL tests in internal/encoder use the external test package pattern.
  </action>
  <verify>
`go test -c ./internal/encoder` compiles without errors
`go test -v ./internal/encoder/...` runs all tests
  </verify>
  <done>All internal/encoder test files use external test package pattern</done>
</task>

<task type="auto">
  <name>Task 3: Verify full test suite passes</name>
  <files>None (verification only)</files>
  <action>
Run the full test suite to verify:

1. `go test ./...` completes without import cycle errors
2. All tests pass (or skip gracefully on macOS provenance issues)
3. Test count is preserved (no tests accidentally dropped)

Record the test output showing:
- Total packages tested
- Any skipped tests (with reason)
- All tests passing

If any tests fail for reasons unrelated to the import cycle fix, document them but do not fail the task (known decoder issues exist per STATE.md).
  </action>
  <verify>
`go test ./...` exits 0 (success)
`go test ./... 2>&1 | grep -c "ok "` shows all packages passing
  </verify>
  <done>`go test ./...` passes without import cycle errors; all packages report ok or skip gracefully</done>
</task>

</tasks>

<verification>
- `go test ./...` completes without "import cycle not allowed" error
- All test packages show "ok" status
- Test count in internal/encoder matches before refactor
</verification>

<success_criteria>
- Import cycle eliminated
- `go test ./...` passes (all packages ok or gracefully skipped)
- All existing test assertions preserved
</success_criteria>

<output>
After completion, create `.planning/phases/12-compliance-polish/12-01-SUMMARY.md`
</output>
